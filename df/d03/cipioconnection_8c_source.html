<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>OpENer - Open Source EtherNet/IP(TM)  I/O Target Stack: src/cip/cipioconnection.c Source File</title>

<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">OpENer - Open Source EtherNet/IP(TM)  I/O Target Stack
   &#160;<span id="projectnumber">1.2</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('df/d03/cipioconnection_8c.html','../../');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">src/cip/cipioconnection.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../df/d03/cipioconnection_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*******************************************************************************</span>
<a name="l00002"></a>00002 <span class="comment"> * Copyright (c) 2011, Rockwell Automation, Inc.</span>
<a name="l00003"></a>00003 <span class="comment"> * All rights reserved.</span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> ******************************************************************************/</span>
<a name="l00006"></a>00006 
<a name="l00007"></a>00007 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00008"></a>00008 
<a name="l00009"></a>00009 <span class="preprocessor">#include &quot;<a class="code" href="../../de/d45/cipioconnection_8h.html">cipioconnection.h</a>&quot;</span>
<a name="l00010"></a>00010 
<a name="l00011"></a>00011 <span class="preprocessor">#include &quot;<a class="code" href="../../da/dc2/generic__networkhandler_8h.html">generic_networkhandler.h</a>&quot;</span>
<a name="l00012"></a>00012 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/da3/cipconnectionmanager_8h.html">cipconnectionmanager.h</a>&quot;</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include &quot;<a class="code" href="../../de/df4/cipassembly_8h.html">cipassembly.h</a>&quot;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dad/ciptcpipinterface_8h.html" title="Public interface of the TCP/IP Interface Object.">ciptcpipinterface.h</a>&quot;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d14/cipcommon_8h.html">cipcommon.h</a>&quot;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dc0/appcontype_8h.html">appcontype.h</a>&quot;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/dff/cpf_8h.html">cpf.h</a>&quot;</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d1b/trace_8h.html" title="Tracing infrastructure for OpENer.">trace.h</a>&quot;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/dec/endianconv_8h.html" title="Responsible for Endianess conversion.">endianconv.h</a>&quot;</span>
<a name="l00020"></a>00020 
<a name="l00025"></a><a class="code" href="../../df/d03/cipioconnection_8c.html#ac135b4e48a22ceabff84d2147f00e73d">00025</a> <span class="keyword">typedef</span> <span class="keyword">enum</span> {
<a name="l00026"></a><a class="code" href="../../df/d03/cipioconnection_8c.html#ac135b4e48a22ceabff84d2147f00e73daed5eda863b8019d3edca8fdac1df8bba">00026</a>   <a class="code" href="../../df/d03/cipioconnection_8c.html#ac135b4e48a22ceabff84d2147f00e73daed5eda863b8019d3edca8fdac1df8bba">PointToMultipoint</a> = 1, 
<a name="l00027"></a><a class="code" href="../../df/d03/cipioconnection_8c.html#ac135b4e48a22ceabff84d2147f00e73dae393317b471be5998af43963b2683ec9">00027</a>   <a class="code" href="../../df/d03/cipioconnection_8c.html#ac135b4e48a22ceabff84d2147f00e73dae393317b471be5998af43963b2683ec9">PointToPoint</a> = 2 
<a name="l00028"></a>00028 } <a class="code" href="../../df/d03/cipioconnection_8c.html#ac135b4e48a22ceabff84d2147f00e73d" title="Gives the cardinality of a connection endpoint, either point to point or point to multipoint...">CommunicationEndpointCardinality</a>;
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 <span class="comment">/*The port to be used per default for I/O messages on UDP.*/</span>
<a name="l00031"></a><a class="code" href="../../df/d03/cipioconnection_8c.html#a46f1aa5e4d7142036318ba3c9f2707ea">00031</a> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d03/cipioconnection_8c.html#a46f1aa5e4d7142036318ba3c9f2707ea">kOpenerEipIoUdpPort</a> = 0x08AE;
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 <span class="comment">/* producing multicast connection have to consider the rules that apply for</span>
<a name="l00034"></a>00034 <span class="comment"> * application connection types.</span>
<a name="l00035"></a>00035 <span class="comment"> */</span>
<a name="l00036"></a>00036 <a class="code" href="../../d7/d69/typedefs_8h.html#a3dcc5f7837c120360f8cc88a76781709" title="EIP stack status enum.">EipStatus</a> <a class="code" href="../../df/d03/cipioconnection_8c.html#a281f0a261db50e297593dd3383093fb0">OpenProducingMulticastConnection</a>(
<a name="l00037"></a>00037     <a class="code" href="../../d1/d48/structconnection__object.html">ConnectionObject</a> *<a class="code" href="../../d1/d48/structconnection__object.html">connection_object</a>,
<a name="l00038"></a>00038     <a class="code" href="../../db/d80/structCipCommonPacketFormatData.html">CipCommonPacketFormatData</a> *common_packet_format_data);
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 <a class="code" href="../../d7/d69/typedefs_8h.html#a3dcc5f7837c120360f8cc88a76781709" title="EIP stack status enum.">EipStatus</a> <a class="code" href="../../df/d03/cipioconnection_8c.html#a9937b2aeb5fd393c7861e25f04c9f1c1">OpenMulticastConnection</a>(
<a name="l00041"></a>00041     <a class="code" href="../../d7/d69/typedefs_8h.html#a354b9a030f385814dac5d61a8eec2e42" title="Communication direction of an UDP socket; consuming is receiver, producing is sender.">UdpCommuncationDirection</a> direction, <a class="code" href="../../d1/d48/structconnection__object.html">ConnectionObject</a> *<a class="code" href="../../d1/d48/structconnection__object.html">connection_object</a>,
<a name="l00042"></a>00042     <a class="code" href="../../db/d80/structCipCommonPacketFormatData.html">CipCommonPacketFormatData</a> *common_packet_format_data);
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 <a class="code" href="../../d7/d69/typedefs_8h.html#a3dcc5f7837c120360f8cc88a76781709" title="EIP stack status enum.">EipStatus</a> <a class="code" href="../../df/d03/cipioconnection_8c.html#a6a6634d74fcc5bd0eb35ec8d8c740fb6" title="Open a Point2Point connection dependent on pa_direction.">OpenConsumingPointToPointConnection</a>(
<a name="l00045"></a>00045     <a class="code" href="../../d1/d48/structconnection__object.html">ConnectionObject</a> *<a class="code" href="../../d1/d48/structconnection__object.html">connection_object</a>,
<a name="l00046"></a>00046     <a class="code" href="../../db/d80/structCipCommonPacketFormatData.html">CipCommonPacketFormatData</a> *common_packet_format_data);
<a name="l00047"></a>00047 
<a name="l00048"></a>00048 <a class="code" href="../../d7/d69/typedefs_8h.html#a3dcc5f7837c120360f8cc88a76781709" title="EIP stack status enum.">EipStatus</a> <a class="code" href="../../df/d03/cipioconnection_8c.html#ab5ba6f9cb3103c1db76c2bf7ae3cce8d">OpenProducingPointToPointConnection</a>(
<a name="l00049"></a>00049     <a class="code" href="../../d1/d48/structconnection__object.html">ConnectionObject</a> *<a class="code" href="../../d1/d48/structconnection__object.html">connection_object</a>,
<a name="l00050"></a>00050     <a class="code" href="../../db/d80/structCipCommonPacketFormatData.html">CipCommonPacketFormatData</a> *common_packet_format_data);
<a name="l00051"></a>00051 
<a name="l00052"></a>00052 <a class="code" href="../../d7/d69/typedefs_8h.html#ac1b4cfa25b4f5def62f23b455dd395d8">EipUint16</a> <a class="code" href="../../df/d03/cipioconnection_8c.html#ac2780fe755d65a4c3093a559ebbc6d10">HandleConfigData</a>(<a class="code" href="../../da/d8e/structcip__class.html" title="Class is a subclass of Instance.">CipClass</a> *assembly_class,
<a name="l00053"></a>00053                            <a class="code" href="../../d1/d48/structconnection__object.html">ConnectionObject</a> *<a class="code" href="../../d1/d48/structconnection__object.html">connection_object</a>);
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 <span class="comment">/* Regularly close the IO connection. If it is an exclusive owner or input only</span>
<a name="l00056"></a>00056 <span class="comment"> * connection and in charge of the connection a new owner will be searched</span>
<a name="l00057"></a>00057 <span class="comment"> */</span>
<a name="l00058"></a>00058 <span class="keywordtype">void</span> <a class="code" href="../../df/d03/cipioconnection_8c.html#adb77dcdc1545600764cd212783f5c4e2">CloseIoConnection</a>(<a class="code" href="../../d1/d48/structconnection__object.html">ConnectionObject</a> *<a class="code" href="../../d1/d48/structconnection__object.html">connection_object</a>);
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 <span class="keywordtype">void</span> <a class="code" href="../../df/d03/cipioconnection_8c.html#a043e7b682698cb5a50ced76b6ce10293">HandleIoConnectionTimeOut</a>(<a class="code" href="../../d1/d48/structconnection__object.html">ConnectionObject</a> *<a class="code" href="../../d1/d48/structconnection__object.html">connection_object</a>);
<a name="l00061"></a>00061 
<a name="l00068"></a>00068 <a class="code" href="../../d7/d69/typedefs_8h.html#a3dcc5f7837c120360f8cc88a76781709" title="EIP stack status enum.">EipStatus</a> <a class="code" href="../../df/d03/cipioconnection_8c.html#a41f8d71772b5defa587ac0da6124cc47" title="Send the data from the produced CIP Object of the connection via the socket of the connection object ...">SendConnectedData</a>(<a class="code" href="../../d1/d48/structconnection__object.html">ConnectionObject</a> *<a class="code" href="../../d1/d48/structconnection__object.html">connection_object</a>);
<a name="l00069"></a>00069 
<a name="l00070"></a>00070 <a class="code" href="../../d7/d69/typedefs_8h.html#a3dcc5f7837c120360f8cc88a76781709" title="EIP stack status enum.">EipStatus</a> <a class="code" href="../../df/d03/cipioconnection_8c.html#aca3c7cb7fc5d8d3f86698cb4c31f108f">HandleReceivedIoConnectionData</a>(<a class="code" href="../../d1/d48/structconnection__object.html">ConnectionObject</a> *<a class="code" href="../../d1/d48/structconnection__object.html">connection_object</a>,
<a name="l00071"></a>00071                                          <span class="keyword">const</span> <a class="code" href="../../d7/d69/typedefs_8h.html#aa0c108ee762a27720919a4634643040e">EipUint8</a> *data, <a class="code" href="../../d7/d69/typedefs_8h.html#ac1b4cfa25b4f5def62f23b455dd395d8">EipUint16</a> data_length);
<a name="l00072"></a>00072 
<a name="l00073"></a>00073 <span class="comment">/**** Global variables ****/</span>
<a name="l00074"></a><a class="code" href="../../de/d45/cipioconnection_8h.html#a534c0a24266039f7ced0d36b7c5496bc">00074</a> <a class="code" href="../../d7/d69/typedefs_8h.html#aa0c108ee762a27720919a4634643040e">EipUint8</a> *<a class="code" href="../../df/d03/cipioconnection_8c.html#a534c0a24266039f7ced0d36b7c5496bc">g_config_data_buffer</a> = NULL; 
<a name="l00075"></a><a class="code" href="../../de/d45/cipioconnection_8h.html#ad20328302a359540d55f48ae36f7237d">00075</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d03/cipioconnection_8c.html#ad20328302a359540d55f48ae36f7237d">g_config_data_length</a> = 0;
<a name="l00076"></a>00076 
<a name="l00077"></a><a class="code" href="../../df/d03/cipioconnection_8c.html#a4901ec04ad1ac886626e556c60f12196">00077</a> <a class="code" href="../../d7/d69/typedefs_8h.html#abf2dd49262551294eb990ef8746a2767">EipUint32</a> <a class="code" href="../../df/d03/cipioconnection_8c.html#a4901ec04ad1ac886626e556c60f12196">g_run_idle_state</a>; 
<a name="l00079"></a>00079 <span class="comment">/**** Implementation ****/</span>
<a name="l00080"></a><a class="code" href="../../de/d45/cipioconnection_8h.html#aacd202b378a3fa8d5770536b698a0f51">00080</a> <a class="code" href="../../d7/d69/typedefs_8h.html#a3dcc5f7837c120360f8cc88a76781709" title="EIP stack status enum.">EipStatus</a> <a class="code" href="../../df/d03/cipioconnection_8c.html#aacd202b378a3fa8d5770536b698a0f51" title="Setup all data in order to establish an IO connection.">EstablishIoConnction</a>(<a class="code" href="../../d1/d48/structconnection__object.html">ConnectionObject</a> *RESTRICT <span class="keyword">const</span> <a class="code" href="../../d1/d48/structconnection__object.html">connection_object</a>,
<a name="l00081"></a>00081                          <a class="code" href="../../d7/d69/typedefs_8h.html#ac1b4cfa25b4f5def62f23b455dd395d8">EipUint16</a> *<span class="keyword">const</span> extended_error) {
<a name="l00082"></a>00082   <span class="keywordtype">int</span> originator_to_target_connection_type,
<a name="l00083"></a>00083       target_to_originator_connection_type;
<a name="l00084"></a>00084   <a class="code" href="../../d7/d69/typedefs_8h.html#a3dcc5f7837c120360f8cc88a76781709" title="EIP stack status enum.">EipStatus</a> eip_status = <a class="code" href="../../d7/d69/typedefs_8h.html#a3dcc5f7837c120360f8cc88a76781709af172c48a50748097201d49b469c75f7a">kEipStatusOk</a>;
<a name="l00085"></a>00085   <a class="code" href="../../d4/d62/structCipAttributeStruct.html">CipAttributeStruct</a> *attribute;
<a name="l00086"></a>00086   <span class="comment">/* currently we allow I/O connections only to assembly objects */</span>
<a name="l00087"></a>00087   <a class="code" href="../../da/d8e/structcip__class.html" title="Class is a subclass of Instance.">CipClass</a> *assembly_class = <a class="code" href="../../d2/dc9/group__CIP__API.html#ga98bd609c80ece316406363575b4a89ea" title="Get a pointer to a CIP object with given class code.">GetCipClass</a>(kCipAssemblyClassCode); <span class="comment">/* we don&#39;t need to check for zero as this is handled in the connection path parsing */</span>
<a name="l00088"></a>00088   <a class="code" href="../../d5/dc5/structcip__instance.html">CipInstance</a> *instance = NULL;
<a name="l00089"></a>00089 
<a name="l00090"></a>00090   <a class="code" href="../../d1/d48/structconnection__object.html">ConnectionObject</a> *io_connection_object = <a class="code" href="../../d1/dbc/appcontype_8c.html#a078777f6becb5dd5b858811b546dc523" title="check if for the given connection data received in a forward_open request a suitable connection is av...">GetIoConnectionForConnectionData</a>(
<a name="l00091"></a>00091       connection_object, extended_error);
<a name="l00092"></a>00092 
<a name="l00093"></a>00093   <span class="keywordflow">if</span> (NULL == io_connection_object) {
<a name="l00094"></a>00094     <span class="keywordflow">return</span> <a class="code" href="../../d6/d52/ciperror_8h.html#a01a2d66a1bdaea7c81e29d4d2530d218a8db04c3335e9735af7d59cf4b7cbdc4b">kCipErrorConnectionFailure</a>;
<a name="l00095"></a>00095   }
<a name="l00096"></a>00096 
<a name="l00097"></a>00097   <span class="comment">/* TODO add check for transport type trigger */</span>
<a name="l00098"></a>00098 
<a name="l00099"></a>00099   <span class="keywordflow">if</span> (<a class="code" href="../../d2/da3/cipconnectionmanager_8h.html#a096f9657e36899584e7ee27915734b33ab4f151ab3cda6d2ee76434a213a1c398">kConnectionTriggerTypeCyclicConnection</a>
<a name="l00100"></a>00100       != (io_connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#aee393bffe6bd92fb313db48832665254">transport_type_class_trigger</a>
<a name="l00101"></a>00101           &amp; <a class="code" href="../../d2/da3/cipconnectionmanager_8h.html#a096f9657e36899584e7ee27915734b33aa509cbffa54b97c646ac418d3cde1a15">kConnectionTriggerTypeProductionTriggerMask</a>)) {
<a name="l00102"></a>00102     <span class="keywordflow">if</span> (256 == io_connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#ad0ebc379aa4dc0d0c8d26ef8e3d7f3a8" title="Minimal time between the production of two application triggered or change of state triggered I/O con...">production_inhibit_time</a>) {
<a name="l00103"></a>00103       <span class="comment">/* there was no PIT segment in the connection path set PIT to one fourth of RPI */</span>
<a name="l00104"></a>00104       io_connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#ad0ebc379aa4dc0d0c8d26ef8e3d7f3a8" title="Minimal time between the production of two application triggered or change of state triggered I/O con...">production_inhibit_time</a> =
<a name="l00105"></a>00105           ((<a class="code" href="../../d7/d69/typedefs_8h.html#ac1b4cfa25b4f5def62f23b455dd395d8">EipUint16</a>) (io_connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#adab05e9bb9a28f649747d8df7371d735">t_to_o_requested_packet_interval</a>)
<a name="l00106"></a>00106               / 4000);
<a name="l00107"></a>00107     } <span class="keywordflow">else</span> {
<a name="l00108"></a>00108       <span class="comment">/* if production inhibit time has been provided it needs to be smaller than the RPI */</span>
<a name="l00109"></a>00109       <span class="keywordflow">if</span> (io_connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#ad0ebc379aa4dc0d0c8d26ef8e3d7f3a8" title="Minimal time between the production of two application triggered or change of state triggered I/O con...">production_inhibit_time</a>
<a name="l00110"></a>00110           &gt; ((<a class="code" href="../../d7/d69/typedefs_8h.html#ac1b4cfa25b4f5def62f23b455dd395d8">EipUint16</a>) ((io_connection_object
<a name="l00111"></a>00111               -&gt;<a class="code" href="../../d1/d48/structconnection__object.html#adab05e9bb9a28f649747d8df7371d735">t_to_o_requested_packet_interval</a>) / 1000))) {
<a name="l00112"></a>00112         <span class="comment">/* see section C-1.4.3.3 */</span>
<a name="l00113"></a>00113         *extended_error = 0x111; 
<a name="l00114"></a>00114         <span class="keywordflow">return</span> <a class="code" href="../../d6/d52/ciperror_8h.html#a01a2d66a1bdaea7c81e29d4d2530d218a8db04c3335e9735af7d59cf4b7cbdc4b">kCipErrorConnectionFailure</a>;
<a name="l00115"></a>00115       }
<a name="l00116"></a>00116     }
<a name="l00117"></a>00117   }
<a name="l00118"></a>00118   <span class="comment">/* set the connection call backs */</span>
<a name="l00119"></a>00119   io_connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a51af396f09a2874cecd1d463c85e2a34">connection_close_function</a> = <a class="code" href="../../df/d03/cipioconnection_8c.html#adb77dcdc1545600764cd212783f5c4e2">CloseIoConnection</a>;
<a name="l00120"></a>00120   io_connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a1188e39b93ec13c5dca2c1c56d6ab07e">connection_timeout_function</a> = <a class="code" href="../../df/d03/cipioconnection_8c.html#a043e7b682698cb5a50ced76b6ce10293">HandleIoConnectionTimeOut</a>;
<a name="l00121"></a>00121   io_connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#ab54770913f007d4ca02e10835352649d">connection_send_data_function</a> = <a class="code" href="../../df/d03/cipioconnection_8c.html#a41f8d71772b5defa587ac0da6124cc47" title="Send the data from the produced CIP Object of the connection via the socket of the connection object ...">SendConnectedData</a>;
<a name="l00122"></a>00122   io_connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#af885b8e00c36002715d9cbb32b56f3a2">connection_receive_data_function</a> =
<a name="l00123"></a>00123       <a class="code" href="../../df/d03/cipioconnection_8c.html#aca3c7cb7fc5d8d3f86698cb4c31f108f">HandleReceivedIoConnectionData</a>;
<a name="l00124"></a>00124 
<a name="l00125"></a>00125   <a class="code" href="../../d5/d35/cipconnectionmanager_8c.html#a58ea5ad416416102edd225bc918bd6bd" title="Generate the ConnectionIDs and set the general configuration parameter in the given connection object...">GeneralConnectionConfiguration</a>(io_connection_object);
<a name="l00126"></a>00126 
<a name="l00127"></a>00127   originator_to_target_connection_type = (io_connection_object
<a name="l00128"></a>00128       -&gt;<a class="code" href="../../d1/d48/structconnection__object.html#af1d980ce6b30a318e559cf32d23aa0ec">o_to_t_network_connection_parameter</a> &amp; 0x6000) &gt;&gt; 13;
<a name="l00129"></a>00129   target_to_originator_connection_type = (io_connection_object
<a name="l00130"></a>00130       -&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a8ccf723e8dce62eb578a046fd35a774f">t_to_o_network_connection_parameter</a> &amp; 0x6000) &gt;&gt; 13;
<a name="l00131"></a>00131 
<a name="l00132"></a>00132   <span class="keywordflow">if</span> ((originator_to_target_connection_type == 0)
<a name="l00133"></a>00133       &amp;&amp; (target_to_originator_connection_type == 0)) { <span class="comment">/* this indicates an re-configuration of the connection currently not supported and we should not come here as this is handled in the forwardopen function*/</span>
<a name="l00134"></a>00134 
<a name="l00135"></a>00135   } <span class="keywordflow">else</span> {
<a name="l00136"></a>00136     <span class="keywordtype">int</span> producing_index = 0;
<a name="l00137"></a>00137     <span class="keywordtype">int</span> data_size;
<a name="l00138"></a>00138     <span class="keywordtype">int</span> diff_size;
<a name="l00139"></a>00139     <span class="keywordtype">int</span> is_heartbeat = <span class="keyword">false</span>;
<a name="l00140"></a>00140 
<a name="l00141"></a>00141     <span class="keywordflow">if</span> ((originator_to_target_connection_type != 0)
<a name="l00142"></a>00142         &amp;&amp; (target_to_originator_connection_type != 0)) { <span class="comment">/* we have a producing and consuming connection*/</span>
<a name="l00143"></a>00143       producing_index = 1;
<a name="l00144"></a>00144     }
<a name="l00145"></a>00145 
<a name="l00146"></a>00146     io_connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#aef7f726017a6d89235c9ee8c0ef98d71">consuming_instance</a> = 0;
<a name="l00147"></a>00147     io_connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a65eb419da766d2f8a43fc03b14a152f3">consumed_connection_path_length</a> = 0;
<a name="l00148"></a>00148     io_connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#ab486fb828cb85f57c53abea69ad9faff">producing_instance</a> = 0;
<a name="l00149"></a>00149     io_connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a7c7b4c524189f7894f06ca75187a756c">produced_connection_path_length</a> = 0;
<a name="l00150"></a>00150 
<a name="l00151"></a>00151     <span class="keywordflow">if</span> (originator_to_target_connection_type != 0) { <span class="comment">/*setup consumer side*/</span>
<a name="l00152"></a>00152       <span class="keywordflow">if</span> (0
<a name="l00153"></a>00153           != (instance = <a class="code" href="../../d2/dc9/group__CIP__API.html#gaa50395aca91b378c297d6ad919df210e" title="Get a pointer to an instance.">GetCipInstance</a>(
<a name="l00154"></a>00154               assembly_class,
<a name="l00155"></a>00155               io_connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a7ea92b8fc46bb305035ed3547516e0a7">connection_path</a>.<a class="code" href="../../dd/d06/structCipConnectionPath.html#a4f909044fc44d1e1028c105f045aca1d">connection_point</a>[0]))) { <span class="comment">/* consuming Connection Point is present */</span>
<a name="l00156"></a>00156         io_connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#aef7f726017a6d89235c9ee8c0ef98d71">consuming_instance</a> = instance;
<a name="l00157"></a>00157 
<a name="l00158"></a>00158         io_connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a65eb419da766d2f8a43fc03b14a152f3">consumed_connection_path_length</a> = 6;
<a name="l00159"></a>00159         io_connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#ab3ad0cdf7a707fb8554f0c2705999122">consumed_connection_path</a>.<a class="code" href="../../d5/dd2/structCipEpath.html#af99160e384c9add3cd99fa48f1c83059">path_size</a> = 6;
<a name="l00160"></a>00160         io_connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#ab3ad0cdf7a707fb8554f0c2705999122">consumed_connection_path</a>.<a class="code" href="../../d5/dd2/structCipEpath.html#afa1bed6dacf38bea9ec26342f33f4fc6">class_id</a> =
<a name="l00161"></a>00161             io_connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a7ea92b8fc46bb305035ed3547516e0a7">connection_path</a>.<a class="code" href="../../dd/d06/structCipConnectionPath.html#ac8161b95364182279d18be321752ee15">class_id</a>;
<a name="l00162"></a>00162         io_connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#ab3ad0cdf7a707fb8554f0c2705999122">consumed_connection_path</a>.<a class="code" href="../../d5/dd2/structCipEpath.html#a206c078bbda5b614b96cd61fd18d1cab">instance_number</a> =
<a name="l00163"></a>00163             io_connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a7ea92b8fc46bb305035ed3547516e0a7">connection_path</a>.<a class="code" href="../../dd/d06/structCipConnectionPath.html#a4f909044fc44d1e1028c105f045aca1d">connection_point</a>[0];
<a name="l00164"></a>00164         io_connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#ab3ad0cdf7a707fb8554f0c2705999122">consumed_connection_path</a>.<a class="code" href="../../d5/dd2/structCipEpath.html#a4c9dee9e353080f53bcc041745849bbe">attribute_number</a> = 3;
<a name="l00165"></a>00165 
<a name="l00166"></a>00166         attribute = <a class="code" href="../../d2/dc9/group__CIP__API.html#ga5a14c8d76acacb09312b709bb0a76265" title="Get a pointer to an instance&#39;s attribute.">GetCipAttribute</a>(instance, 3);
<a name="l00167"></a>00167         <a class="code" href="../../dd/d1b/POSIX_2sample__application_2opener__user__conf_8h.html#a7b5e7d71f666ba97788b35be1617c40a">OPENER_ASSERT</a>(attribute != NULL);
<a name="l00168"></a>00168         <span class="comment">/* an assembly object should always have an attribute 3 */</span>
<a name="l00169"></a>00169         data_size = io_connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a657c244a2fd4dbc4f313470bb635748a">consumed_connection_size</a>;
<a name="l00170"></a>00170         diff_size = 0;
<a name="l00171"></a>00171         is_heartbeat = (((<a class="code" href="../../de/dd7/structCipByteArray.html" title="CIP Byte Array.">CipByteArray</a> *) attribute-&gt;<a class="code" href="../../d4/d62/structCipAttributeStruct.html#a859d8bdd91ff42b1ce0ff5f8053d2b40">data</a>)-&gt;length == 0);
<a name="l00172"></a>00172 
<a name="l00173"></a>00173         <span class="keywordflow">if</span> ((io_connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#aee393bffe6bd92fb313db48832665254">transport_type_class_trigger</a> &amp; 0x0F) == 1) {
<a name="l00174"></a>00174           <span class="comment">/* class 1 connection */</span>
<a name="l00175"></a>00175           data_size -= 2; <span class="comment">/* remove 16-bit sequence count length */</span>
<a name="l00176"></a>00176           diff_size += 2;
<a name="l00177"></a>00177         }
<a name="l00178"></a>00178         <span class="keywordflow">if</span> ((kOpenerConsumedDataHasRunIdleHeader) &amp;&amp;(data_size &gt; 0)
<a name="l00179"></a>00179             &amp;&amp; (!is_heartbeat)) { <span class="comment">/* we only have an run idle header if it is not an heartbeat connection */</span>
<a name="l00180"></a>00180           data_size -= 4; <span class="comment">/* remove the 4 bytes needed for run/idle header */</span>
<a name="l00181"></a>00181           diff_size += 4;
<a name="l00182"></a>00182         }
<a name="l00183"></a>00183         <span class="keywordflow">if</span> (((<a class="code" href="../../de/dd7/structCipByteArray.html" title="CIP Byte Array.">CipByteArray</a> *) attribute-&gt;<a class="code" href="../../d4/d62/structCipAttributeStruct.html#a859d8bdd91ff42b1ce0ff5f8053d2b40">data</a>)-&gt;length != data_size) {
<a name="l00184"></a>00184           <span class="comment">/*wrong connection size */</span>
<a name="l00185"></a>00185           connection_object-&gt;correct_originator_to_target_size =
<a name="l00186"></a>00186               ((<a class="code" href="../../de/dd7/structCipByteArray.html" title="CIP Byte Array.">CipByteArray</a> *) attribute-&gt;<a class="code" href="../../d4/d62/structCipAttributeStruct.html#a859d8bdd91ff42b1ce0ff5f8053d2b40">data</a>)-&gt;length + diff_size;
<a name="l00187"></a>00187           *extended_error =
<a name="l00188"></a>00188               <a class="code" href="../../d2/da3/cipconnectionmanager_8h.html#af7249e248108913b85a50b2edaaf6021a8d4a78c93c66235da54adae315872f57">kConnectionManagerStatusCodeErrorInvalidOToTConnectionSize</a>;
<a name="l00189"></a>00189           <span class="keywordflow">return</span> <a class="code" href="../../d6/d52/ciperror_8h.html#a01a2d66a1bdaea7c81e29d4d2530d218a8db04c3335e9735af7d59cf4b7cbdc4b">kCipErrorConnectionFailure</a>;
<a name="l00190"></a>00190         }
<a name="l00191"></a>00191       } <span class="keywordflow">else</span> {
<a name="l00192"></a>00192         *extended_error =
<a name="l00193"></a>00193             <a class="code" href="../../d2/da3/cipconnectionmanager_8h.html#af7249e248108913b85a50b2edaaf6021a04aaa69af344dfeb2c721f2587b24d0f">kConnectionManagerStatusCodeInvalidConsumingApllicationPath</a>;
<a name="l00194"></a>00194         <span class="keywordflow">return</span> <a class="code" href="../../d6/d52/ciperror_8h.html#a01a2d66a1bdaea7c81e29d4d2530d218a8db04c3335e9735af7d59cf4b7cbdc4b">kCipErrorConnectionFailure</a>;
<a name="l00195"></a>00195       }
<a name="l00196"></a>00196     }
<a name="l00197"></a>00197 
<a name="l00198"></a>00198     <span class="keywordflow">if</span> (target_to_originator_connection_type != 0) { <span class="comment">/*setup producer side*/</span>
<a name="l00199"></a>00199       <span class="keywordflow">if</span> (0
<a name="l00200"></a>00200           != (instance =
<a name="l00201"></a>00201               <a class="code" href="../../d2/dc9/group__CIP__API.html#gaa50395aca91b378c297d6ad919df210e" title="Get a pointer to an instance.">GetCipInstance</a>(
<a name="l00202"></a>00202                   assembly_class,
<a name="l00203"></a>00203                   io_connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a7ea92b8fc46bb305035ed3547516e0a7">connection_path</a>.<a class="code" href="../../dd/d06/structCipConnectionPath.html#a4f909044fc44d1e1028c105f045aca1d">connection_point</a>[producing_index]))) {
<a name="l00204"></a>00204         io_connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#ab486fb828cb85f57c53abea69ad9faff">producing_instance</a> = instance;
<a name="l00205"></a>00205 
<a name="l00206"></a>00206         io_connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a7c7b4c524189f7894f06ca75187a756c">produced_connection_path_length</a> = 6;
<a name="l00207"></a>00207         io_connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a0a9a5ce0afe8cd5890c11e901bc9a099">produced_connection_path</a>.<a class="code" href="../../d5/dd2/structCipEpath.html#af99160e384c9add3cd99fa48f1c83059">path_size</a> = 6;
<a name="l00208"></a>00208         io_connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a0a9a5ce0afe8cd5890c11e901bc9a099">produced_connection_path</a>.<a class="code" href="../../d5/dd2/structCipEpath.html#afa1bed6dacf38bea9ec26342f33f4fc6">class_id</a> =
<a name="l00209"></a>00209             io_connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a7ea92b8fc46bb305035ed3547516e0a7">connection_path</a>.<a class="code" href="../../dd/d06/structCipConnectionPath.html#ac8161b95364182279d18be321752ee15">class_id</a>;
<a name="l00210"></a>00210         io_connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a0a9a5ce0afe8cd5890c11e901bc9a099">produced_connection_path</a>.<a class="code" href="../../d5/dd2/structCipEpath.html#a206c078bbda5b614b96cd61fd18d1cab">instance_number</a> =
<a name="l00211"></a>00211             io_connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a7ea92b8fc46bb305035ed3547516e0a7">connection_path</a>.<a class="code" href="../../dd/d06/structCipConnectionPath.html#a4f909044fc44d1e1028c105f045aca1d">connection_point</a>[producing_index];
<a name="l00212"></a>00212         io_connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a0a9a5ce0afe8cd5890c11e901bc9a099">produced_connection_path</a>.<a class="code" href="../../d5/dd2/structCipEpath.html#a4c9dee9e353080f53bcc041745849bbe">attribute_number</a> = 3;
<a name="l00213"></a>00213 
<a name="l00214"></a>00214         attribute = <a class="code" href="../../d2/dc9/group__CIP__API.html#ga5a14c8d76acacb09312b709bb0a76265" title="Get a pointer to an instance&#39;s attribute.">GetCipAttribute</a>(instance, 3);
<a name="l00215"></a>00215         <a class="code" href="../../dd/d1b/POSIX_2sample__application_2opener__user__conf_8h.html#a7b5e7d71f666ba97788b35be1617c40a">OPENER_ASSERT</a>(attribute != NULL);
<a name="l00216"></a>00216         <span class="comment">/* an assembly object should always have an attribute 3 */</span>
<a name="l00217"></a>00217         data_size = io_connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a06f2c634d47a6b2883821737aff5ec03">produced_connection_size</a>;
<a name="l00218"></a>00218         diff_size = 0;
<a name="l00219"></a>00219         is_heartbeat = (((<a class="code" href="../../de/dd7/structCipByteArray.html" title="CIP Byte Array.">CipByteArray</a> *) attribute-&gt;<a class="code" href="../../d4/d62/structCipAttributeStruct.html#a859d8bdd91ff42b1ce0ff5f8053d2b40">data</a>)-&gt;length == 0);
<a name="l00220"></a>00220 
<a name="l00221"></a>00221         <span class="keywordflow">if</span> ((io_connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#aee393bffe6bd92fb313db48832665254">transport_type_class_trigger</a> &amp; 0x0F) == 1) {
<a name="l00222"></a>00222           <span class="comment">/* class 1 connection */</span>
<a name="l00223"></a>00223           data_size -= 2; <span class="comment">/* remove 16-bit sequence count length */</span>
<a name="l00224"></a>00224           diff_size += 2;
<a name="l00225"></a>00225         }
<a name="l00226"></a>00226         <span class="keywordflow">if</span> ((kOpenerProducedDataHasRunIdleHeader) &amp;&amp;(data_size &gt; 0)
<a name="l00227"></a>00227             &amp;&amp; (!is_heartbeat)) { <span class="comment">/* we only have an run idle header if it is not an heartbeat connection */</span>
<a name="l00228"></a>00228           data_size -= 4; <span class="comment">/* remove the 4 bytes needed for run/idle header */</span>
<a name="l00229"></a>00229           diff_size += 4;
<a name="l00230"></a>00230         }
<a name="l00231"></a>00231         <span class="keywordflow">if</span> (((<a class="code" href="../../de/dd7/structCipByteArray.html" title="CIP Byte Array.">CipByteArray</a> *) attribute-&gt;<a class="code" href="../../d4/d62/structCipAttributeStruct.html#a859d8bdd91ff42b1ce0ff5f8053d2b40">data</a>)-&gt;length != data_size) {
<a name="l00232"></a>00232           <span class="comment">/*wrong connection size*/</span>
<a name="l00233"></a>00233           connection_object-&gt;correct_target_to_originator_size =
<a name="l00234"></a>00234               ((<a class="code" href="../../de/dd7/structCipByteArray.html" title="CIP Byte Array.">CipByteArray</a> *) attribute-&gt;<a class="code" href="../../d4/d62/structCipAttributeStruct.html#a859d8bdd91ff42b1ce0ff5f8053d2b40">data</a>)-&gt;length + diff_size;
<a name="l00235"></a>00235           *extended_error =
<a name="l00236"></a>00236               <a class="code" href="../../d2/da3/cipconnectionmanager_8h.html#af7249e248108913b85a50b2edaaf6021ae1f6a08715d0ef773db1eabd32d7e7fb">kConnectionManagerStatusCodeErrorInvalidTToOConnectionSize</a>;
<a name="l00237"></a>00237           <span class="keywordflow">return</span> <a class="code" href="../../d6/d52/ciperror_8h.html#a01a2d66a1bdaea7c81e29d4d2530d218a8db04c3335e9735af7d59cf4b7cbdc4b">kCipErrorConnectionFailure</a>;
<a name="l00238"></a>00238         }
<a name="l00239"></a>00239 
<a name="l00240"></a>00240       } <span class="keywordflow">else</span> {
<a name="l00241"></a>00241         *extended_error =
<a name="l00242"></a>00242             <a class="code" href="../../d2/da3/cipconnectionmanager_8h.html#af7249e248108913b85a50b2edaaf6021a25b6037b89ef78644f4873d48025d049">kConnectionManagerStatusCodeInvalidProducingApplicationPath</a>;
<a name="l00243"></a>00243         <span class="keywordflow">return</span> <a class="code" href="../../d6/d52/ciperror_8h.html#a01a2d66a1bdaea7c81e29d4d2530d218a8db04c3335e9735af7d59cf4b7cbdc4b">kCipErrorConnectionFailure</a>;
<a name="l00244"></a>00244       }
<a name="l00245"></a>00245     }
<a name="l00246"></a>00246 
<a name="l00247"></a>00247     <span class="keywordflow">if</span> (NULL != <a class="code" href="../../df/d03/cipioconnection_8c.html#a534c0a24266039f7ced0d36b7c5496bc">g_config_data_buffer</a>) { <span class="comment">/* config data has been sent with this forward open request */</span>
<a name="l00248"></a>00248       *extended_error = <a class="code" href="../../df/d03/cipioconnection_8c.html#ac2780fe755d65a4c3093a559ebbc6d10">HandleConfigData</a>(assembly_class, io_connection_object);
<a name="l00249"></a>00249       <span class="keywordflow">if</span> (0 != *extended_error) {
<a name="l00250"></a>00250         <span class="keywordflow">return</span> <a class="code" href="../../d6/d52/ciperror_8h.html#a01a2d66a1bdaea7c81e29d4d2530d218a8db04c3335e9735af7d59cf4b7cbdc4b">kCipErrorConnectionFailure</a>;
<a name="l00251"></a>00251       }
<a name="l00252"></a>00252     }
<a name="l00253"></a>00253 
<a name="l00254"></a>00254     eip_status = <a class="code" href="../../df/d03/cipioconnection_8c.html#adbb39670c736df4ef89589a3b4e4df4e" title="Take the data given in the connection object structure and open the necessary communication channels...">OpenCommunicationChannels</a>(io_connection_object);
<a name="l00255"></a>00255     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d69/typedefs_8h.html#a3dcc5f7837c120360f8cc88a76781709af172c48a50748097201d49b469c75f7a">kEipStatusOk</a> != eip_status) {
<a name="l00256"></a>00256       *extended_error = 0; <span class="comment">/*TODO find out the correct extended error code*/</span>
<a name="l00257"></a>00257       <span class="keywordflow">return</span> eip_status;
<a name="l00258"></a>00258     }
<a name="l00259"></a>00259   }
<a name="l00260"></a>00260 
<a name="l00261"></a>00261   <a class="code" href="../../d5/d35/cipconnectionmanager_8c.html#a9414ca20f400db7e4d219dddd953a004" title="Insert the given connection object to the list of currently active and managed connections.">AddNewActiveConnection</a>(io_connection_object);
<a name="l00262"></a>00262   <a class="code" href="../../d5/dc5/group__CIP__CALLBACK__API.html#gac9c9ad2c2254b783e7b447bd84eba8c0" title="Inform the application on changes occurred for a connection.">CheckIoConnectionEvent</a>(io_connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a7ea92b8fc46bb305035ed3547516e0a7">connection_path</a>.<a class="code" href="../../dd/d06/structCipConnectionPath.html#a4f909044fc44d1e1028c105f045aca1d">connection_point</a>[0],
<a name="l00263"></a>00263                     io_connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a7ea92b8fc46bb305035ed3547516e0a7">connection_path</a>.<a class="code" href="../../dd/d06/structCipConnectionPath.html#a4f909044fc44d1e1028c105f045aca1d">connection_point</a>[1],
<a name="l00264"></a>00264                     <a class="code" href="../../df/d28/ciptypes_8h.html#a1a7498137431124c4dde66e95095c2d2a6516f9d6e660daf124379a38608434e2">kIoConnectionEventOpened</a>);
<a name="l00265"></a>00265   <span class="keywordflow">return</span> eip_status;
<a name="l00266"></a>00266 }
<a name="l00267"></a>00267 
<a name="l00274"></a><a class="code" href="../../df/d03/cipioconnection_8c.html#a6a6634d74fcc5bd0eb35ec8d8c740fb6">00274</a> <a class="code" href="../../d7/d69/typedefs_8h.html#a3dcc5f7837c120360f8cc88a76781709" title="EIP stack status enum.">EipStatus</a> <a class="code" href="../../df/d03/cipioconnection_8c.html#a6a6634d74fcc5bd0eb35ec8d8c740fb6" title="Open a Point2Point connection dependent on pa_direction.">OpenConsumingPointToPointConnection</a>(
<a name="l00275"></a>00275     <a class="code" href="../../d1/d48/structconnection__object.html">ConnectionObject</a> *<a class="code" href="../../d1/d48/structconnection__object.html">connection_object</a>,
<a name="l00276"></a>00276     <a class="code" href="../../db/d80/structCipCommonPacketFormatData.html">CipCommonPacketFormatData</a> *common_packet_format_data) {
<a name="l00277"></a>00277   <span class="comment">/*static EIP_UINT16 nUDPPort = 2222; TODO think on improving the udp port assigment for point to point connections */</span>
<a name="l00278"></a>00278   <span class="keywordtype">int</span> j = 0;
<a name="l00279"></a>00279 
<a name="l00280"></a>00280   <span class="keywordflow">if</span> (common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#afc2883222efe7445cb7836d5da872f54">address_info_item</a>[0].<a class="code" href="../../dc/d3c/structSocketAddressInfoItem.html#ad71289b55ab0ff6a4382af44afaccca2">type_id</a> == 0) { <span class="comment">/* it is not used yet */</span>
<a name="l00281"></a>00281     j = 0;
<a name="l00282"></a>00282   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#afc2883222efe7445cb7836d5da872f54">address_info_item</a>[1].<a class="code" href="../../dc/d3c/structSocketAddressInfoItem.html#ad71289b55ab0ff6a4382af44afaccca2">type_id</a> == 0) {
<a name="l00283"></a>00283     j = 1;
<a name="l00284"></a>00284   }
<a name="l00285"></a>00285 
<a name="l00286"></a>00286   <span class="keyword">struct </span>sockaddr_in addr = { .sin_family = PF_INET, .sin_addr.s_addr = INADDR_ANY, .sin_port = htons(<a class="code" href="../../df/d03/cipioconnection_8c.html#a46f1aa5e4d7142036318ba3c9f2707ea">kOpenerEipIoUdpPort</a>) };
<a name="l00287"></a>00287 
<a name="l00288"></a>00288   <span class="keywordtype">int</span> socket = <a class="code" href="../../d5/dc5/group__CIP__CALLBACK__API.html#gadae462526ab01253d39e4a54346f56ca" title="create a producing or consuming UDP socket">CreateUdpSocket</a>(<a class="code" href="../../d7/d69/typedefs_8h.html#a354b9a030f385814dac5d61a8eec2e42a922e4c2f521c295287766f9917c9fea7">kUdpCommuncationDirectionConsuming</a>, &amp;addr); <span class="comment">/* the address is only needed for bind used if consuming */</span>
<a name="l00289"></a>00289   <span class="keywordflow">if</span> (socket == kEipInvalidSocket) {
<a name="l00290"></a>00290     <a class="code" href="../../d1/d1b/trace_8h.html#a48f0d8056c030015f14cf5907315e6bb">OPENER_TRACE_ERR</a>(
<a name="l00291"></a>00291         <span class="stringliteral">&quot;cannot create UDP socket in OpenPointToPointConnection\n&quot;</span>);
<a name="l00292"></a>00292     <span class="keywordflow">return</span> <a class="code" href="../../d7/d69/typedefs_8h.html#a3dcc5f7837c120360f8cc88a76781709a1ac5aa8c4de11fc51d52843b5d173184">kEipStatusError</a>;
<a name="l00293"></a>00293   }
<a name="l00294"></a>00294 
<a name="l00295"></a>00295   connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a122616a0d743a67d5333a79c57ba50b8">originator_address</a> = addr; <span class="comment">/* store the address of the originator for packet scanning */</span>
<a name="l00296"></a>00296   addr.sin_addr.s_addr = INADDR_ANY; <span class="comment">/* restore the address */</span>
<a name="l00297"></a>00297   connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#af79cffac5d391cb48b836dca8b893fe4">socket</a>[<a class="code" href="../../d7/d69/typedefs_8h.html#a354b9a030f385814dac5d61a8eec2e42a922e4c2f521c295287766f9917c9fea7">kUdpCommuncationDirectionConsuming</a>] = socket;
<a name="l00298"></a>00298 
<a name="l00299"></a>00299   common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#afc2883222efe7445cb7836d5da872f54">address_info_item</a>[j].<a class="code" href="../../dc/d3c/structSocketAddressInfoItem.html#a8933e644c7191ea8f5a22401b2e6a6fa">length</a> = 16;
<a name="l00300"></a>00300   common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#afc2883222efe7445cb7836d5da872f54">address_info_item</a>[j].<a class="code" href="../../dc/d3c/structSocketAddressInfoItem.html#ad71289b55ab0ff6a4382af44afaccca2">type_id</a> =
<a name="l00301"></a>00301       <a class="code" href="../../d4/d91/group__ENCAP.html#ggafdcff621008b5e305165424c6ac4ea25a93851549b6af1ed796409633e8071623">kCipItemIdSocketAddressInfoOriginatorToTarget</a>;
<a name="l00302"></a>00302 
<a name="l00303"></a>00303   common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#afc2883222efe7445cb7836d5da872f54">address_info_item</a>[j].<a class="code" href="../../dc/d3c/structSocketAddressInfoItem.html#a3f7a4600643a87742112758468b42146">sin_port</a> = addr.sin_port;
<a name="l00304"></a>00304   <span class="comment">/*TODO should we add our own address here? */</span>
<a name="l00305"></a>00305   common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#afc2883222efe7445cb7836d5da872f54">address_info_item</a>[j].<a class="code" href="../../dc/d3c/structSocketAddressInfoItem.html#a46921af5bef9ee04546194f8d19d3163">sin_addr</a> = addr.sin_addr
<a name="l00306"></a>00306       .s_addr;
<a name="l00307"></a>00307   memset(common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#afc2883222efe7445cb7836d5da872f54">address_info_item</a>[j].<a class="code" href="../../dc/d3c/structSocketAddressInfoItem.html#abaf556494b9fea3137c6c45522ab9bda">nasin_zero</a>, 0, 8);
<a name="l00308"></a>00308   common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#afc2883222efe7445cb7836d5da872f54">address_info_item</a>[j].<a class="code" href="../../dc/d3c/structSocketAddressInfoItem.html#a6698e4b44eeaf0795025d0be524b8e8a">sin_family</a> = htons(AF_INET);
<a name="l00309"></a>00309 
<a name="l00310"></a>00310   <span class="keywordflow">return</span> <a class="code" href="../../d7/d69/typedefs_8h.html#a3dcc5f7837c120360f8cc88a76781709af172c48a50748097201d49b469c75f7a">kEipStatusOk</a>;
<a name="l00311"></a>00311 }
<a name="l00312"></a>00312 
<a name="l00313"></a><a class="code" href="../../df/d03/cipioconnection_8c.html#ab5ba6f9cb3103c1db76c2bf7ae3cce8d">00313</a> <a class="code" href="../../d7/d69/typedefs_8h.html#a3dcc5f7837c120360f8cc88a76781709" title="EIP stack status enum.">EipStatus</a> <a class="code" href="../../df/d03/cipioconnection_8c.html#ab5ba6f9cb3103c1db76c2bf7ae3cce8d">OpenProducingPointToPointConnection</a>(
<a name="l00314"></a>00314     <a class="code" href="../../d1/d48/structconnection__object.html">ConnectionObject</a> *<a class="code" href="../../d1/d48/structconnection__object.html">connection_object</a>,
<a name="l00315"></a>00315     <a class="code" href="../../db/d80/structCipCommonPacketFormatData.html">CipCommonPacketFormatData</a> *common_packet_format_data) {
<a name="l00316"></a>00316   <a class="code" href="../../db/d9c/WIN32_2sample__application_2opener__user__conf_8h.html#adc5174418a78989eb51ef56f622db6e3">in_port_t</a> port = htons(<a class="code" href="../../df/d03/cipioconnection_8c.html#a46f1aa5e4d7142036318ba3c9f2707ea">kOpenerEipIoUdpPort</a>); <span class="comment">/* the default port to be used if no port information is part of the forward open request */</span>
<a name="l00317"></a>00317 
<a name="l00318"></a>00318   <span class="keywordflow">if</span> (<a class="code" href="../../d4/d91/group__ENCAP.html#ggafdcff621008b5e305165424c6ac4ea25aef2e6ffe3e7443b14842d173c7f1e75d">kCipItemIdSocketAddressInfoTargetToOriginator</a>
<a name="l00319"></a>00319       == common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#afc2883222efe7445cb7836d5da872f54">address_info_item</a>[0].<a class="code" href="../../dc/d3c/structSocketAddressInfoItem.html#ad71289b55ab0ff6a4382af44afaccca2">type_id</a>) {
<a name="l00320"></a>00320     port = common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#afc2883222efe7445cb7836d5da872f54">address_info_item</a>[0].<a class="code" href="../../dc/d3c/structSocketAddressInfoItem.html#a3f7a4600643a87742112758468b42146">sin_port</a>;
<a name="l00321"></a>00321   } <span class="keywordflow">else</span> {
<a name="l00322"></a>00322     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d91/group__ENCAP.html#ggafdcff621008b5e305165424c6ac4ea25aef2e6ffe3e7443b14842d173c7f1e75d">kCipItemIdSocketAddressInfoTargetToOriginator</a>
<a name="l00323"></a>00323         == common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#afc2883222efe7445cb7836d5da872f54">address_info_item</a>[1].<a class="code" href="../../dc/d3c/structSocketAddressInfoItem.html#ad71289b55ab0ff6a4382af44afaccca2">type_id</a>) {
<a name="l00324"></a>00324       port = common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#afc2883222efe7445cb7836d5da872f54">address_info_item</a>[1].<a class="code" href="../../dc/d3c/structSocketAddressInfoItem.html#a3f7a4600643a87742112758468b42146">sin_port</a>;
<a name="l00325"></a>00325     }
<a name="l00326"></a>00326   }
<a name="l00327"></a>00327 
<a name="l00328"></a>00328   connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a32b8fe01a538f765d0cce564f705c2ea">remote_address</a>.sin_family = AF_INET;
<a name="l00329"></a>00329   connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a32b8fe01a538f765d0cce564f705c2ea">remote_address</a>.sin_addr.s_addr = 0; <span class="comment">/* we don&#39;t know the address of the originate will be set in the IApp_CreateUDPSocket */</span>
<a name="l00330"></a>00330   connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a32b8fe01a538f765d0cce564f705c2ea">remote_address</a>.sin_port = port;
<a name="l00331"></a>00331 
<a name="l00332"></a>00332   <span class="keywordtype">int</span> socket = <a class="code" href="../../d5/dc5/group__CIP__CALLBACK__API.html#gadae462526ab01253d39e4a54346f56ca" title="create a producing or consuming UDP socket">CreateUdpSocket</a>(<a class="code" href="../../d7/d69/typedefs_8h.html#a354b9a030f385814dac5d61a8eec2e42aeb4cf2b383958e411d35e88ae386c5ec">kUdpCommuncationDirectionProducing</a>,
<a name="l00333"></a>00333                            &amp;connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a32b8fe01a538f765d0cce564f705c2ea">remote_address</a>); <span class="comment">/* the address is only needed for bind used if consuming */</span>
<a name="l00334"></a>00334   <span class="keywordflow">if</span> (socket == kEipInvalidSocket) {
<a name="l00335"></a>00335     <a class="code" href="../../d1/d1b/trace_8h.html#a48f0d8056c030015f14cf5907315e6bb">OPENER_TRACE_ERR</a>(
<a name="l00336"></a>00336         <span class="stringliteral">&quot;cannot create UDP socket in OpenPointToPointConnection\n&quot;</span>);
<a name="l00337"></a>00337     <span class="comment">/* *pa_pnExtendedError = 0x0315; miscellaneous*/</span>
<a name="l00338"></a>00338     <span class="keywordflow">return</span> <a class="code" href="../../d6/d52/ciperror_8h.html#a01a2d66a1bdaea7c81e29d4d2530d218a8db04c3335e9735af7d59cf4b7cbdc4b">kCipErrorConnectionFailure</a>;
<a name="l00339"></a>00339   }
<a name="l00340"></a>00340   connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#af79cffac5d391cb48b836dca8b893fe4">socket</a>[<a class="code" href="../../d7/d69/typedefs_8h.html#a354b9a030f385814dac5d61a8eec2e42aeb4cf2b383958e411d35e88ae386c5ec">kUdpCommuncationDirectionProducing</a>] = socket;
<a name="l00341"></a>00341 
<a name="l00342"></a>00342   <span class="keywordflow">return</span> <a class="code" href="../../d7/d69/typedefs_8h.html#a3dcc5f7837c120360f8cc88a76781709af172c48a50748097201d49b469c75f7a">kEipStatusOk</a>;
<a name="l00343"></a>00343 }
<a name="l00344"></a>00344 
<a name="l00345"></a><a class="code" href="../../df/d03/cipioconnection_8c.html#a281f0a261db50e297593dd3383093fb0">00345</a> <a class="code" href="../../d7/d69/typedefs_8h.html#a3dcc5f7837c120360f8cc88a76781709" title="EIP stack status enum.">EipStatus</a> <a class="code" href="../../df/d03/cipioconnection_8c.html#a281f0a261db50e297593dd3383093fb0">OpenProducingMulticastConnection</a>(
<a name="l00346"></a>00346     <a class="code" href="../../d1/d48/structconnection__object.html">ConnectionObject</a> *<a class="code" href="../../d1/d48/structconnection__object.html">connection_object</a>,
<a name="l00347"></a>00347     <a class="code" href="../../db/d80/structCipCommonPacketFormatData.html">CipCommonPacketFormatData</a> *common_packet_format_data) {
<a name="l00348"></a>00348   <a class="code" href="../../d1/d48/structconnection__object.html">ConnectionObject</a> *existing_connection_object =
<a name="l00349"></a>00349       <a class="code" href="../../d1/dbc/appcontype_8c.html#a7b838b128170044eb0d81371c9f0bb49" title="Check if there exists already an exclusive owner or listen only connection which produces the input a...">GetExistingProducerMulticastConnection</a>(
<a name="l00350"></a>00350           connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a7ea92b8fc46bb305035ed3547516e0a7">connection_path</a>.<a class="code" href="../../dd/d06/structCipConnectionPath.html#a4f909044fc44d1e1028c105f045aca1d">connection_point</a>[1]);
<a name="l00351"></a>00351 
<a name="l00352"></a>00352   <span class="keywordflow">if</span> (NULL == existing_connection_object) { <span class="comment">/* we are the first connection producing for the given Input Assembly */</span>
<a name="l00353"></a>00353     <span class="keywordflow">return</span> <a class="code" href="../../df/d03/cipioconnection_8c.html#a9937b2aeb5fd393c7861e25f04c9f1c1">OpenMulticastConnection</a>(<a class="code" href="../../d7/d69/typedefs_8h.html#a354b9a030f385814dac5d61a8eec2e42aeb4cf2b383958e411d35e88ae386c5ec">kUdpCommuncationDirectionProducing</a>,
<a name="l00354"></a>00354                                    connection_object, common_packet_format_data);
<a name="l00355"></a>00355   } <span class="keywordflow">else</span> {
<a name="l00356"></a>00356     <span class="comment">/* we need to inform our originator on the correct connection id */</span>
<a name="l00357"></a>00357     connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a1094de5e83a2b9f85b2a622c1a01bfbe">produced_connection_id</a> = existing_connection_object
<a name="l00358"></a>00358         -&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a1094de5e83a2b9f85b2a622c1a01bfbe">produced_connection_id</a>;
<a name="l00359"></a>00359   }
<a name="l00360"></a>00360 
<a name="l00361"></a>00361   <span class="comment">/* we have a connection reuse the data and the socket */</span>
<a name="l00362"></a>00362 
<a name="l00363"></a>00363   <span class="keywordtype">int</span> j = 0; <span class="comment">/* allocate an unused sockaddr struct to use */</span>
<a name="l00364"></a>00364   <span class="keywordflow">if</span> (<a class="code" href="../../d4/d91/group__ENCAP.html#gafaae5be8de81c633ea4df46fa8b957e0" title="Data storage for the any CPF data Currently we are single threaded and need only one CPF at the time...">g_common_packet_format_data_item</a>.<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#afc2883222efe7445cb7836d5da872f54">address_info_item</a>[0].<a class="code" href="../../dc/d3c/structSocketAddressInfoItem.html#ad71289b55ab0ff6a4382af44afaccca2">type_id</a> == 0) { <span class="comment">/* it is not used yet */</span>
<a name="l00365"></a>00365     j = 0;
<a name="l00366"></a>00366   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d91/group__ENCAP.html#gafaae5be8de81c633ea4df46fa8b957e0" title="Data storage for the any CPF data Currently we are single threaded and need only one CPF at the time...">g_common_packet_format_data_item</a>.<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#afc2883222efe7445cb7836d5da872f54">address_info_item</a>[1].<a class="code" href="../../dc/d3c/structSocketAddressInfoItem.html#ad71289b55ab0ff6a4382af44afaccca2">type_id</a>
<a name="l00367"></a>00367       == 0) {
<a name="l00368"></a>00368     j = 1;
<a name="l00369"></a>00369   }
<a name="l00370"></a>00370 
<a name="l00371"></a>00371   <span class="keywordflow">if</span> (<a class="code" href="../../d2/da3/cipconnectionmanager_8h.html#aa1f0e2efd52935fd01bfece0fbead81fa49da9a89c43c187253492f976225db82">kConnectionTypeIoExclusiveOwner</a> == connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#ada63f5853b16b3fa0d3c49b894157540">instance_type</a>) {
<a name="l00372"></a>00372     <span class="comment">/* exclusive owners take the socket and further manage the connection</span>
<a name="l00373"></a>00373 <span class="comment">     * especially in the case of time outs.</span>
<a name="l00374"></a>00374 <span class="comment">     */</span>
<a name="l00375"></a>00375     connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#af79cffac5d391cb48b836dca8b893fe4">socket</a>[<a class="code" href="../../d7/d69/typedefs_8h.html#a354b9a030f385814dac5d61a8eec2e42aeb4cf2b383958e411d35e88ae386c5ec">kUdpCommuncationDirectionProducing</a>] =
<a name="l00376"></a>00376         existing_connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#af79cffac5d391cb48b836dca8b893fe4">socket</a>[<a class="code" href="../../d7/d69/typedefs_8h.html#a354b9a030f385814dac5d61a8eec2e42aeb4cf2b383958e411d35e88ae386c5ec">kUdpCommuncationDirectionProducing</a>];
<a name="l00377"></a>00377     existing_connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#af79cffac5d391cb48b836dca8b893fe4">socket</a>[<a class="code" href="../../d7/d69/typedefs_8h.html#a354b9a030f385814dac5d61a8eec2e42aeb4cf2b383958e411d35e88ae386c5ec">kUdpCommuncationDirectionProducing</a>] =
<a name="l00378"></a>00378         kEipInvalidSocket;
<a name="l00379"></a>00379   } <span class="keywordflow">else</span> { <span class="comment">/* this connection will not produce the data */</span>
<a name="l00380"></a>00380     connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#af79cffac5d391cb48b836dca8b893fe4">socket</a>[<a class="code" href="../../d7/d69/typedefs_8h.html#a354b9a030f385814dac5d61a8eec2e42aeb4cf2b383958e411d35e88ae386c5ec">kUdpCommuncationDirectionProducing</a>] =
<a name="l00381"></a>00381         kEipInvalidSocket;
<a name="l00382"></a>00382   }
<a name="l00383"></a>00383 
<a name="l00384"></a>00384   common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#afc2883222efe7445cb7836d5da872f54">address_info_item</a>[j].<a class="code" href="../../dc/d3c/structSocketAddressInfoItem.html#a8933e644c7191ea8f5a22401b2e6a6fa">length</a> = 16;
<a name="l00385"></a>00385   common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#afc2883222efe7445cb7836d5da872f54">address_info_item</a>[j].<a class="code" href="../../dc/d3c/structSocketAddressInfoItem.html#ad71289b55ab0ff6a4382af44afaccca2">type_id</a> =
<a name="l00386"></a>00386       <a class="code" href="../../d4/d91/group__ENCAP.html#ggafdcff621008b5e305165424c6ac4ea25aef2e6ffe3e7443b14842d173c7f1e75d">kCipItemIdSocketAddressInfoTargetToOriginator</a>;
<a name="l00387"></a>00387   connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a32b8fe01a538f765d0cce564f705c2ea">remote_address</a>.sin_family = AF_INET;
<a name="l00388"></a>00388   connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a32b8fe01a538f765d0cce564f705c2ea">remote_address</a>.sin_port = common_packet_format_data
<a name="l00389"></a>00389       -&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#afc2883222efe7445cb7836d5da872f54">address_info_item</a>[j].<a class="code" href="../../dc/d3c/structSocketAddressInfoItem.html#a3f7a4600643a87742112758468b42146">sin_port</a> = htons(<a class="code" href="../../df/d03/cipioconnection_8c.html#a46f1aa5e4d7142036318ba3c9f2707ea">kOpenerEipIoUdpPort</a>);
<a name="l00390"></a>00390   connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a32b8fe01a538f765d0cce564f705c2ea">remote_address</a>.sin_addr.s_addr = common_packet_format_data
<a name="l00391"></a>00391       -&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#afc2883222efe7445cb7836d5da872f54">address_info_item</a>[j].<a class="code" href="../../dc/d3c/structSocketAddressInfoItem.html#a46921af5bef9ee04546194f8d19d3163">sin_addr</a> = <a class="code" href="../../dd/d20/ciptcpipinterface_8c.html#a3b13a18a3f6efcb8f2e651676096f4e5" title="#9 The multicast configuration for this device">g_multicast_configuration</a>
<a name="l00392"></a>00392       .<a class="code" href="../../db/dd7/structmulticast__address__configuration.html#a983b98b7087072214bc4fc803b938df3">starting_multicast_address</a>;
<a name="l00393"></a>00393   memset(common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#afc2883222efe7445cb7836d5da872f54">address_info_item</a>[j].<a class="code" href="../../dc/d3c/structSocketAddressInfoItem.html#abaf556494b9fea3137c6c45522ab9bda">nasin_zero</a>, 0, 8);
<a name="l00394"></a>00394   common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#afc2883222efe7445cb7836d5da872f54">address_info_item</a>[j].<a class="code" href="../../dc/d3c/structSocketAddressInfoItem.html#a6698e4b44eeaf0795025d0be524b8e8a">sin_family</a> = htons(AF_INET);
<a name="l00395"></a>00395 
<a name="l00396"></a>00396   <span class="keywordflow">return</span> <a class="code" href="../../d7/d69/typedefs_8h.html#a3dcc5f7837c120360f8cc88a76781709af172c48a50748097201d49b469c75f7a">kEipStatusOk</a>;
<a name="l00397"></a>00397 }
<a name="l00398"></a>00398 
<a name="l00406"></a><a class="code" href="../../df/d03/cipioconnection_8c.html#a9937b2aeb5fd393c7861e25f04c9f1c1">00406</a> <a class="code" href="../../d7/d69/typedefs_8h.html#a3dcc5f7837c120360f8cc88a76781709" title="EIP stack status enum.">EipStatus</a> <a class="code" href="../../df/d03/cipioconnection_8c.html#a9937b2aeb5fd393c7861e25f04c9f1c1">OpenMulticastConnection</a>(
<a name="l00407"></a>00407     <a class="code" href="../../d7/d69/typedefs_8h.html#a354b9a030f385814dac5d61a8eec2e42" title="Communication direction of an UDP socket; consuming is receiver, producing is sender.">UdpCommuncationDirection</a> direction, <a class="code" href="../../d1/d48/structconnection__object.html">ConnectionObject</a> *<a class="code" href="../../d1/d48/structconnection__object.html">connection_object</a>,
<a name="l00408"></a>00408     <a class="code" href="../../db/d80/structCipCommonPacketFormatData.html">CipCommonPacketFormatData</a> *common_packet_format_data) {
<a name="l00409"></a>00409   <span class="keywordtype">int</span> j = 0;
<a name="l00410"></a>00410 
<a name="l00411"></a>00411   <span class="keywordflow">if</span> (0 != <a class="code" href="../../d4/d91/group__ENCAP.html#gafaae5be8de81c633ea4df46fa8b957e0" title="Data storage for the any CPF data Currently we are single threaded and need only one CPF at the time...">g_common_packet_format_data_item</a>.<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#afc2883222efe7445cb7836d5da872f54">address_info_item</a>[0].<a class="code" href="../../dc/d3c/structSocketAddressInfoItem.html#ad71289b55ab0ff6a4382af44afaccca2">type_id</a>) {
<a name="l00412"></a>00412     <span class="keywordflow">if</span> ((<a class="code" href="../../d7/d69/typedefs_8h.html#a354b9a030f385814dac5d61a8eec2e42a922e4c2f521c295287766f9917c9fea7">kUdpCommuncationDirectionConsuming</a> == direction)
<a name="l00413"></a>00413         &amp;&amp; (<a class="code" href="../../d4/d91/group__ENCAP.html#ggafdcff621008b5e305165424c6ac4ea25a93851549b6af1ed796409633e8071623">kCipItemIdSocketAddressInfoOriginatorToTarget</a>
<a name="l00414"></a>00414             == common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#afc2883222efe7445cb7836d5da872f54">address_info_item</a>[0].<a class="code" href="../../dc/d3c/structSocketAddressInfoItem.html#ad71289b55ab0ff6a4382af44afaccca2">type_id</a>)) {
<a name="l00415"></a>00415       <span class="comment">/* for consuming connection points the originator can choose the multicast address to use</span>
<a name="l00416"></a>00416 <span class="comment">       * we have a given address type so use it */</span>
<a name="l00417"></a>00417     } <span class="keywordflow">else</span> {
<a name="l00418"></a>00418       j = 1;
<a name="l00419"></a>00419       <span class="comment">/* if the type is not zero (not used) or if a given type it has to be the correct one */</span>
<a name="l00420"></a>00420       <span class="keywordflow">if</span> ((0 != <a class="code" href="../../d4/d91/group__ENCAP.html#gafaae5be8de81c633ea4df46fa8b957e0" title="Data storage for the any CPF data Currently we are single threaded and need only one CPF at the time...">g_common_packet_format_data_item</a>.<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#afc2883222efe7445cb7836d5da872f54">address_info_item</a>[1].<a class="code" href="../../dc/d3c/structSocketAddressInfoItem.html#ad71289b55ab0ff6a4382af44afaccca2">type_id</a>)
<a name="l00421"></a>00421           &amp;&amp; (!((<a class="code" href="../../d7/d69/typedefs_8h.html#a354b9a030f385814dac5d61a8eec2e42a922e4c2f521c295287766f9917c9fea7">kUdpCommuncationDirectionConsuming</a> == direction)
<a name="l00422"></a>00422               &amp;&amp; (<a class="code" href="../../d4/d91/group__ENCAP.html#ggafdcff621008b5e305165424c6ac4ea25a93851549b6af1ed796409633e8071623">kCipItemIdSocketAddressInfoOriginatorToTarget</a>
<a name="l00423"></a>00423                   == common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#afc2883222efe7445cb7836d5da872f54">address_info_item</a>[0].<a class="code" href="../../dc/d3c/structSocketAddressInfoItem.html#ad71289b55ab0ff6a4382af44afaccca2">type_id</a>)))) {
<a name="l00424"></a>00424         <a class="code" href="../../d1/d1b/trace_8h.html#a48f0d8056c030015f14cf5907315e6bb">OPENER_TRACE_ERR</a>(<span class="stringliteral">&quot;no suitable addr info item available\n&quot;</span>);
<a name="l00425"></a>00425         <span class="keywordflow">return</span> <a class="code" href="../../d7/d69/typedefs_8h.html#a3dcc5f7837c120360f8cc88a76781709a1ac5aa8c4de11fc51d52843b5d173184">kEipStatusError</a>;
<a name="l00426"></a>00426       }
<a name="l00427"></a>00427     }
<a name="l00428"></a>00428   }
<a name="l00429"></a>00429 
<a name="l00430"></a>00430   <span class="keywordflow">if</span> (0 == common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#afc2883222efe7445cb7836d5da872f54">address_info_item</a>[j].<a class="code" href="../../dc/d3c/structSocketAddressInfoItem.html#ad71289b55ab0ff6a4382af44afaccca2">type_id</a>) { <span class="comment">/* we are using an unused item initialize it with the default multicast address */</span>
<a name="l00431"></a>00431     common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#afc2883222efe7445cb7836d5da872f54">address_info_item</a>[j].<a class="code" href="../../dc/d3c/structSocketAddressInfoItem.html#a6698e4b44eeaf0795025d0be524b8e8a">sin_family</a> = htons(
<a name="l00432"></a>00432         AF_INET);
<a name="l00433"></a>00433     common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#afc2883222efe7445cb7836d5da872f54">address_info_item</a>[j].<a class="code" href="../../dc/d3c/structSocketAddressInfoItem.html#a3f7a4600643a87742112758468b42146">sin_port</a> = htons(
<a name="l00434"></a>00434         <a class="code" href="../../df/d03/cipioconnection_8c.html#a46f1aa5e4d7142036318ba3c9f2707ea">kOpenerEipIoUdpPort</a>);
<a name="l00435"></a>00435     common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#afc2883222efe7445cb7836d5da872f54">address_info_item</a>[j].<a class="code" href="../../dc/d3c/structSocketAddressInfoItem.html#a46921af5bef9ee04546194f8d19d3163">sin_addr</a> =
<a name="l00436"></a>00436         <a class="code" href="../../dd/d20/ciptcpipinterface_8c.html#a3b13a18a3f6efcb8f2e651676096f4e5" title="#9 The multicast configuration for this device">g_multicast_configuration</a>.<a class="code" href="../../db/dd7/structmulticast__address__configuration.html#a983b98b7087072214bc4fc803b938df3">starting_multicast_address</a>;
<a name="l00437"></a>00437     memset(common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#afc2883222efe7445cb7836d5da872f54">address_info_item</a>[j].<a class="code" href="../../dc/d3c/structSocketAddressInfoItem.html#abaf556494b9fea3137c6c45522ab9bda">nasin_zero</a>, 0, 8);
<a name="l00438"></a>00438     common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#afc2883222efe7445cb7836d5da872f54">address_info_item</a>[j].<a class="code" href="../../dc/d3c/structSocketAddressInfoItem.html#a8933e644c7191ea8f5a22401b2e6a6fa">length</a> = 16;
<a name="l00439"></a>00439   }
<a name="l00440"></a>00440 
<a name="l00441"></a>00441   <span class="keywordflow">if</span> (htons(AF_INET)
<a name="l00442"></a>00442       != common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#afc2883222efe7445cb7836d5da872f54">address_info_item</a>[j].<a class="code" href="../../dc/d3c/structSocketAddressInfoItem.html#a6698e4b44eeaf0795025d0be524b8e8a">sin_family</a>) {
<a name="l00443"></a>00443     <a class="code" href="../../d1/d1b/trace_8h.html#a48f0d8056c030015f14cf5907315e6bb">OPENER_TRACE_ERR</a>(
<a name="l00444"></a>00444         <span class="stringliteral">&quot;Sockaddr Info Item with wrong sin family value recieved\n&quot;</span>);
<a name="l00445"></a>00445     <span class="keywordflow">return</span> <a class="code" href="../../d7/d69/typedefs_8h.html#a3dcc5f7837c120360f8cc88a76781709a1ac5aa8c4de11fc51d52843b5d173184">kEipStatusError</a>;
<a name="l00446"></a>00446   }
<a name="l00447"></a>00447 
<a name="l00448"></a>00448   <span class="comment">/* allocate an unused sockaddr struct to use */</span>
<a name="l00449"></a>00449   <span class="keyword">struct </span>sockaddr_in socket_address;
<a name="l00450"></a>00450   socket_address.sin_family = ntohs(
<a name="l00451"></a>00451       common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#afc2883222efe7445cb7836d5da872f54">address_info_item</a>[j].<a class="code" href="../../dc/d3c/structSocketAddressInfoItem.html#a6698e4b44eeaf0795025d0be524b8e8a">sin_family</a>);
<a name="l00452"></a>00452   socket_address.sin_addr.s_addr =
<a name="l00453"></a>00453       common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#afc2883222efe7445cb7836d5da872f54">address_info_item</a>[j].<a class="code" href="../../dc/d3c/structSocketAddressInfoItem.html#a46921af5bef9ee04546194f8d19d3163">sin_addr</a>;
<a name="l00454"></a>00454   socket_address.sin_port = common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#afc2883222efe7445cb7836d5da872f54">address_info_item</a>[j]
<a name="l00455"></a>00455       .<a class="code" href="../../dc/d3c/structSocketAddressInfoItem.html#a3f7a4600643a87742112758468b42146">sin_port</a>;
<a name="l00456"></a>00456 
<a name="l00457"></a>00457   <span class="keywordtype">int</span> socket = <a class="code" href="../../d5/dc5/group__CIP__CALLBACK__API.html#gadae462526ab01253d39e4a54346f56ca" title="create a producing or consuming UDP socket">CreateUdpSocket</a>(direction, &amp;socket_address); <span class="comment">/* the address is only needed for bind used if consuming */</span>
<a name="l00458"></a>00458   <span class="keywordflow">if</span> (socket == kEipInvalidSocket) {
<a name="l00459"></a>00459     <a class="code" href="../../d1/d1b/trace_8h.html#a48f0d8056c030015f14cf5907315e6bb">OPENER_TRACE_ERR</a>(<span class="stringliteral">&quot;cannot create UDP socket in OpenMulticastConnection\n&quot;</span>);
<a name="l00460"></a>00460     <span class="keywordflow">return</span> <a class="code" href="../../d7/d69/typedefs_8h.html#a3dcc5f7837c120360f8cc88a76781709a1ac5aa8c4de11fc51d52843b5d173184">kEipStatusError</a>;
<a name="l00461"></a>00461   }
<a name="l00462"></a>00462   connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#af79cffac5d391cb48b836dca8b893fe4">socket</a>[direction] = socket;
<a name="l00463"></a>00463 
<a name="l00464"></a>00464   <span class="keywordflow">if</span> (direction == <a class="code" href="../../d7/d69/typedefs_8h.html#a354b9a030f385814dac5d61a8eec2e42a922e4c2f521c295287766f9917c9fea7">kUdpCommuncationDirectionConsuming</a>) {
<a name="l00465"></a>00465     common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#afc2883222efe7445cb7836d5da872f54">address_info_item</a>[j].<a class="code" href="../../dc/d3c/structSocketAddressInfoItem.html#ad71289b55ab0ff6a4382af44afaccca2">type_id</a> =
<a name="l00466"></a>00466         <a class="code" href="../../d4/d91/group__ENCAP.html#ggafdcff621008b5e305165424c6ac4ea25a93851549b6af1ed796409633e8071623">kCipItemIdSocketAddressInfoOriginatorToTarget</a>;
<a name="l00467"></a>00467     connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a122616a0d743a67d5333a79c57ba50b8">originator_address</a> = socket_address;
<a name="l00468"></a>00468   } <span class="keywordflow">else</span> {
<a name="l00469"></a>00469     common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#afc2883222efe7445cb7836d5da872f54">address_info_item</a>[j].<a class="code" href="../../dc/d3c/structSocketAddressInfoItem.html#ad71289b55ab0ff6a4382af44afaccca2">type_id</a> =
<a name="l00470"></a>00470         <a class="code" href="../../d4/d91/group__ENCAP.html#ggafdcff621008b5e305165424c6ac4ea25aef2e6ffe3e7443b14842d173c7f1e75d">kCipItemIdSocketAddressInfoTargetToOriginator</a>;
<a name="l00471"></a>00471     connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a32b8fe01a538f765d0cce564f705c2ea">remote_address</a> = socket_address;
<a name="l00472"></a>00472   }
<a name="l00473"></a>00473 
<a name="l00474"></a>00474   <span class="keywordflow">return</span> <a class="code" href="../../d7/d69/typedefs_8h.html#a3dcc5f7837c120360f8cc88a76781709af172c48a50748097201d49b469c75f7a">kEipStatusOk</a>;
<a name="l00475"></a>00475 }
<a name="l00476"></a>00476 
<a name="l00477"></a><a class="code" href="../../df/d03/cipioconnection_8c.html#ac2780fe755d65a4c3093a559ebbc6d10">00477</a> <a class="code" href="../../d7/d69/typedefs_8h.html#ac1b4cfa25b4f5def62f23b455dd395d8">EipUint16</a> <a class="code" href="../../df/d03/cipioconnection_8c.html#ac2780fe755d65a4c3093a559ebbc6d10">HandleConfigData</a>(<a class="code" href="../../da/d8e/structcip__class.html" title="Class is a subclass of Instance.">CipClass</a> *assembly_class,
<a name="l00478"></a>00478                            <a class="code" href="../../d1/d48/structconnection__object.html">ConnectionObject</a> *<a class="code" href="../../d1/d48/structconnection__object.html">connection_object</a>) {
<a name="l00479"></a>00479   <a class="code" href="../../d7/d69/typedefs_8h.html#ac1b4cfa25b4f5def62f23b455dd395d8">EipUint16</a> connection_manager_status = 0;
<a name="l00480"></a>00480   <a class="code" href="../../d5/dc5/structcip__instance.html">CipInstance</a> *config_instance = <a class="code" href="../../d2/dc9/group__CIP__API.html#gaa50395aca91b378c297d6ad919df210e" title="Get a pointer to an instance.">GetCipInstance</a>(
<a name="l00481"></a>00481       assembly_class, connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a7ea92b8fc46bb305035ed3547516e0a7">connection_path</a>.<a class="code" href="../../dd/d06/structCipConnectionPath.html#a4f909044fc44d1e1028c105f045aca1d">connection_point</a>[2]);
<a name="l00482"></a>00482 
<a name="l00483"></a>00483   <span class="keywordflow">if</span> (0 != <a class="code" href="../../df/d03/cipioconnection_8c.html#ad20328302a359540d55f48ae36f7237d">g_config_data_length</a>) {
<a name="l00484"></a>00484     <span class="keywordflow">if</span> (<a class="code" href="../../d1/dbc/appcontype_8c.html#aea7e180dc280ec82f06282864f84097a" title="Check if there is an established connection that uses the same config point.">ConnectionWithSameConfigPointExists</a>(
<a name="l00485"></a>00485         connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a7ea92b8fc46bb305035ed3547516e0a7">connection_path</a>.<a class="code" href="../../dd/d06/structCipConnectionPath.html#a4f909044fc44d1e1028c105f045aca1d">connection_point</a>[2])) { <span class="comment">/* there is a connected connection with the same config point</span>
<a name="l00486"></a>00486 <span class="comment">         * we have to have the same data as already present in the config point*/</span>
<a name="l00487"></a>00487       <a class="code" href="../../de/dd7/structCipByteArray.html" title="CIP Byte Array.">CipByteArray</a> *attribute_three = (<a class="code" href="../../de/dd7/structCipByteArray.html" title="CIP Byte Array.">CipByteArray</a> *) <a class="code" href="../../d2/dc9/group__CIP__API.html#ga5a14c8d76acacb09312b709bb0a76265" title="Get a pointer to an instance&#39;s attribute.">GetCipAttribute</a>(config_instance, 3)
<a name="l00488"></a>00488           -&gt;<a class="code" href="../../d4/d62/structCipAttributeStruct.html#a859d8bdd91ff42b1ce0ff5f8053d2b40">data</a>;
<a name="l00489"></a>00489       <span class="keywordflow">if</span> (attribute_three-&gt;<a class="code" href="../../de/dd7/structCipByteArray.html#a2fc468bacd1d1300da4286bb838b7f7b">length</a> != <a class="code" href="../../df/d03/cipioconnection_8c.html#ad20328302a359540d55f48ae36f7237d">g_config_data_length</a>) {
<a name="l00490"></a>00490         connection_manager_status =
<a name="l00491"></a>00491             <a class="code" href="../../d2/da3/cipconnectionmanager_8h.html#af7249e248108913b85a50b2edaaf6021a54c5b1ae141df32143094a99940b642a">kConnectionManagerStatusCodeErrorOwnershipConflict</a>;
<a name="l00492"></a>00492       } <span class="keywordflow">else</span> {
<a name="l00493"></a>00493         <span class="comment">/*FIXME check if this is correct */</span>
<a name="l00494"></a>00494         <span class="keywordflow">if</span> (memcmp(attribute_three-&gt;<a class="code" href="../../de/dd7/structCipByteArray.html#ad1f95b3da0adfd2aeafd5db1d415a6b9">data</a>, <a class="code" href="../../df/d03/cipioconnection_8c.html#a534c0a24266039f7ced0d36b7c5496bc">g_config_data_buffer</a>, <a class="code" href="../../df/d03/cipioconnection_8c.html#ad20328302a359540d55f48ae36f7237d">g_config_data_length</a>)) {
<a name="l00495"></a>00495           connection_manager_status =
<a name="l00496"></a>00496               <a class="code" href="../../d2/da3/cipconnectionmanager_8h.html#af7249e248108913b85a50b2edaaf6021a54c5b1ae141df32143094a99940b642a">kConnectionManagerStatusCodeErrorOwnershipConflict</a>;
<a name="l00497"></a>00497         }
<a name="l00498"></a>00498       }
<a name="l00499"></a>00499     } <span class="keywordflow">else</span> {
<a name="l00500"></a>00500       <span class="comment">/* put the data on the configuration assembly object with the current</span>
<a name="l00501"></a>00501 <span class="comment">       design this can be done rather efficiently */</span>
<a name="l00502"></a>00502       <span class="keywordflow">if</span> (<a class="code" href="../../d7/d69/typedefs_8h.html#a3dcc5f7837c120360f8cc88a76781709af172c48a50748097201d49b469c75f7a">kEipStatusOk</a>
<a name="l00503"></a>00503           != <a class="code" href="../../df/d2e/cipassembly_8c.html#a5dc25129faf75858c0aeaa88ea8d9490" title="notify an Assembly object that data has been received for it.">NotifyAssemblyConnectedDataReceived</a>(config_instance,
<a name="l00504"></a>00504                                                  <a class="code" href="../../df/d03/cipioconnection_8c.html#a534c0a24266039f7ced0d36b7c5496bc">g_config_data_buffer</a>,
<a name="l00505"></a>00505                                                  <a class="code" href="../../df/d03/cipioconnection_8c.html#ad20328302a359540d55f48ae36f7237d">g_config_data_length</a>)) {
<a name="l00506"></a>00506         <a class="code" href="../../d1/d1b/trace_8h.html#aa1b39db9477c48695273170aff3c3a7a">OPENER_TRACE_WARN</a>(<span class="stringliteral">&quot;Configuration data was invalid\n&quot;</span>);
<a name="l00507"></a>00507         connection_manager_status =
<a name="l00508"></a>00508             <a class="code" href="../../d2/da3/cipconnectionmanager_8h.html#af7249e248108913b85a50b2edaaf6021aa68a2676ee1bb16abf8dd72a2a5cd824">kConnectionManagerStatusCodeInvalidConfigurationApplicationPath</a>;
<a name="l00509"></a>00509       }
<a name="l00510"></a>00510     }
<a name="l00511"></a>00511   }
<a name="l00512"></a>00512   <span class="keywordflow">return</span> connection_manager_status;
<a name="l00513"></a>00513 }
<a name="l00514"></a>00514 
<a name="l00515"></a><a class="code" href="../../df/d03/cipioconnection_8c.html#adb77dcdc1545600764cd212783f5c4e2">00515</a> <span class="keywordtype">void</span> <a class="code" href="../../df/d03/cipioconnection_8c.html#adb77dcdc1545600764cd212783f5c4e2">CloseIoConnection</a>(<a class="code" href="../../d1/d48/structconnection__object.html">ConnectionObject</a> *<a class="code" href="../../d1/d48/structconnection__object.html">connection_object</a>) {
<a name="l00516"></a>00516 
<a name="l00517"></a>00517   <a class="code" href="../../d5/dc5/group__CIP__CALLBACK__API.html#gac9c9ad2c2254b783e7b447bd84eba8c0" title="Inform the application on changes occurred for a connection.">CheckIoConnectionEvent</a>(connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a7ea92b8fc46bb305035ed3547516e0a7">connection_path</a>.<a class="code" href="../../dd/d06/structCipConnectionPath.html#a4f909044fc44d1e1028c105f045aca1d">connection_point</a>[0],
<a name="l00518"></a>00518                     connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a7ea92b8fc46bb305035ed3547516e0a7">connection_path</a>.<a class="code" href="../../dd/d06/structCipConnectionPath.html#a4f909044fc44d1e1028c105f045aca1d">connection_point</a>[1],
<a name="l00519"></a>00519                     <a class="code" href="../../df/d28/ciptypes_8h.html#a1a7498137431124c4dde66e95095c2d2aef7d80152c2d6e1a5e7f64bf51801374">kIoConnectionEventClosed</a>);
<a name="l00520"></a>00520 
<a name="l00521"></a>00521   <span class="keywordflow">if</span> ((<a class="code" href="../../d2/da3/cipconnectionmanager_8h.html#aa1f0e2efd52935fd01bfece0fbead81fa49da9a89c43c187253492f976225db82">kConnectionTypeIoExclusiveOwner</a> == connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#ada63f5853b16b3fa0d3c49b894157540">instance_type</a>)
<a name="l00522"></a>00522       || (<a class="code" href="../../d2/da3/cipconnectionmanager_8h.html#aa1f0e2efd52935fd01bfece0fbead81fa1d880893638e59b11e4a2874c20ff5c3">kConnectionTypeIoInputOnly</a> == connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#ada63f5853b16b3fa0d3c49b894157540">instance_type</a>)) {
<a name="l00523"></a>00523     <span class="keywordflow">if</span> ((<a class="code" href="../../d2/da3/cipconnectionmanager_8h.html#a5bbe67ba1134d38bbb89c7c242ba6551adbfd343b6fde071643ca6dbdef0493da">kRoutingTypeMulticastConnection</a>
<a name="l00524"></a>00524         == (connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a8ccf723e8dce62eb578a046fd35a774f">t_to_o_network_connection_parameter</a>
<a name="l00525"></a>00525             &amp; <a class="code" href="../../d2/da3/cipconnectionmanager_8h.html#a5bbe67ba1134d38bbb89c7c242ba6551adbfd343b6fde071643ca6dbdef0493da">kRoutingTypeMulticastConnection</a>))
<a name="l00526"></a>00526         &amp;&amp; (kEipInvalidSocket
<a name="l00527"></a>00527             != connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#af79cffac5d391cb48b836dca8b893fe4">socket</a>[<a class="code" href="../../d7/d69/typedefs_8h.html#a354b9a030f385814dac5d61a8eec2e42aeb4cf2b383958e411d35e88ae386c5ec">kUdpCommuncationDirectionProducing</a>])) {
<a name="l00528"></a>00528       <a class="code" href="../../d1/d48/structconnection__object.html">ConnectionObject</a> *next_non_control_master_connection = <a class="code" href="../../d1/dbc/appcontype_8c.html#a1cbf4348c1bb5f1949d7ed38c58b2f27" title="check if there exists an producing multicast exclusive owner or listen only connection that should pr...">GetNextNonControlMasterConnection</a>(
<a name="l00529"></a>00529           connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a7ea92b8fc46bb305035ed3547516e0a7">connection_path</a>.<a class="code" href="../../dd/d06/structCipConnectionPath.html#a4f909044fc44d1e1028c105f045aca1d">connection_point</a>[1]);
<a name="l00530"></a>00530       <span class="keywordflow">if</span> (NULL != next_non_control_master_connection) {
<a name="l00531"></a>00531         next_non_control_master_connection-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#af79cffac5d391cb48b836dca8b893fe4">socket</a>[<a class="code" href="../../d7/d69/typedefs_8h.html#a354b9a030f385814dac5d61a8eec2e42aeb4cf2b383958e411d35e88ae386c5ec">kUdpCommuncationDirectionProducing</a>] =
<a name="l00532"></a>00532             connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#af79cffac5d391cb48b836dca8b893fe4">socket</a>[<a class="code" href="../../d7/d69/typedefs_8h.html#a354b9a030f385814dac5d61a8eec2e42aeb4cf2b383958e411d35e88ae386c5ec">kUdpCommuncationDirectionProducing</a>];
<a name="l00533"></a>00533         memcpy(&amp;(next_non_control_master_connection-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a32b8fe01a538f765d0cce564f705c2ea">remote_address</a>),
<a name="l00534"></a>00534                &amp;(connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a32b8fe01a538f765d0cce564f705c2ea">remote_address</a>),
<a name="l00535"></a>00535                <span class="keyword">sizeof</span>(next_non_control_master_connection-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a32b8fe01a538f765d0cce564f705c2ea">remote_address</a>));
<a name="l00536"></a>00536         next_non_control_master_connection-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#aa31634b17dcfdd7d98ad8b4219558dbf">eip_level_sequence_count_producing</a> =
<a name="l00537"></a>00537             connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#aa31634b17dcfdd7d98ad8b4219558dbf">eip_level_sequence_count_producing</a>;
<a name="l00538"></a>00538         next_non_control_master_connection-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a3bdc60cec812eb1fa09d731971c28c59">sequence_count_producing</a> =
<a name="l00539"></a>00539             connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a3bdc60cec812eb1fa09d731971c28c59">sequence_count_producing</a>;
<a name="l00540"></a>00540         connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#af79cffac5d391cb48b836dca8b893fe4">socket</a>[<a class="code" href="../../d7/d69/typedefs_8h.html#a354b9a030f385814dac5d61a8eec2e42aeb4cf2b383958e411d35e88ae386c5ec">kUdpCommuncationDirectionProducing</a>] =
<a name="l00541"></a>00541             kEipInvalidSocket;
<a name="l00542"></a>00542         next_non_control_master_connection-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a8ff49ae39efff1f6e82d66bca01f995b">transmission_trigger_timer</a> =
<a name="l00543"></a>00543             connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a8ff49ae39efff1f6e82d66bca01f995b">transmission_trigger_timer</a>;
<a name="l00544"></a>00544       } <span class="keywordflow">else</span> { <span class="comment">/* this was the last master connection close all listen only connections listening on the port */</span>
<a name="l00545"></a>00545         <a class="code" href="../../d1/dbc/appcontype_8c.html#a67233ebfb6ba7952669a197a4cf21126" title="Close all connection producing the same input and have the same type (i.e., listen only or input only...">CloseAllConnectionsForInputWithSameType</a>(
<a name="l00546"></a>00546             connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a7ea92b8fc46bb305035ed3547516e0a7">connection_path</a>.<a class="code" href="../../dd/d06/structCipConnectionPath.html#a4f909044fc44d1e1028c105f045aca1d">connection_point</a>[1],
<a name="l00547"></a>00547             <a class="code" href="../../d2/da3/cipconnectionmanager_8h.html#aa1f0e2efd52935fd01bfece0fbead81fae26e447506c01160477cb3de20a1e438">kConnectionTypeIoListenOnly</a>);
<a name="l00548"></a>00548       }
<a name="l00549"></a>00549     }
<a name="l00550"></a>00550   }
<a name="l00551"></a>00551 
<a name="l00552"></a>00552   <a class="code" href="../../df/d03/cipioconnection_8c.html#ab63a9cebd7f44ee474ac1fd446d5bc66" title="close the communication channels of the given connection and remove it from the active connections li...">CloseCommunicationChannelsAndRemoveFromActiveConnectionsList</a>(
<a name="l00553"></a>00553       connection_object);
<a name="l00554"></a>00554 }
<a name="l00555"></a>00555 
<a name="l00556"></a><a class="code" href="../../df/d03/cipioconnection_8c.html#a043e7b682698cb5a50ced76b6ce10293">00556</a> <span class="keywordtype">void</span> <a class="code" href="../../df/d03/cipioconnection_8c.html#a043e7b682698cb5a50ced76b6ce10293">HandleIoConnectionTimeOut</a>(<a class="code" href="../../d1/d48/structconnection__object.html">ConnectionObject</a> *<a class="code" href="../../d1/d48/structconnection__object.html">connection_object</a>) {
<a name="l00557"></a>00557   <a class="code" href="../../d1/d48/structconnection__object.html">ConnectionObject</a> *next_non_control_master_connection;
<a name="l00558"></a>00558   <a class="code" href="../../d5/dc5/group__CIP__CALLBACK__API.html#gac9c9ad2c2254b783e7b447bd84eba8c0" title="Inform the application on changes occurred for a connection.">CheckIoConnectionEvent</a>(connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a7ea92b8fc46bb305035ed3547516e0a7">connection_path</a>.<a class="code" href="../../dd/d06/structCipConnectionPath.html#a4f909044fc44d1e1028c105f045aca1d">connection_point</a>[0],
<a name="l00559"></a>00559                     connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a7ea92b8fc46bb305035ed3547516e0a7">connection_path</a>.<a class="code" href="../../dd/d06/structCipConnectionPath.html#a4f909044fc44d1e1028c105f045aca1d">connection_point</a>[1],
<a name="l00560"></a>00560                     <a class="code" href="../../df/d28/ciptypes_8h.html#a1a7498137431124c4dde66e95095c2d2a91f5cbaf05e3e1e95b9c262a851ae931">kIoConnectionEventTimedOut</a>);
<a name="l00561"></a>00561 
<a name="l00562"></a>00562   <span class="keywordflow">if</span> (<a class="code" href="../../d2/da3/cipconnectionmanager_8h.html#a5bbe67ba1134d38bbb89c7c242ba6551adbfd343b6fde071643ca6dbdef0493da">kRoutingTypeMulticastConnection</a>
<a name="l00563"></a>00563       == (connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a8ccf723e8dce62eb578a046fd35a774f">t_to_o_network_connection_parameter</a>
<a name="l00564"></a>00564           &amp; <a class="code" href="../../d2/da3/cipconnectionmanager_8h.html#a5bbe67ba1134d38bbb89c7c242ba6551adbfd343b6fde071643ca6dbdef0493da">kRoutingTypeMulticastConnection</a>)) {
<a name="l00565"></a>00565     <span class="keywordflow">switch</span> (connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#ada63f5853b16b3fa0d3c49b894157540">instance_type</a>) {
<a name="l00566"></a>00566       <span class="keywordflow">case</span> <a class="code" href="../../d2/da3/cipconnectionmanager_8h.html#aa1f0e2efd52935fd01bfece0fbead81fa49da9a89c43c187253492f976225db82">kConnectionTypeIoExclusiveOwner</a>:
<a name="l00567"></a>00567         <a class="code" href="../../d1/dbc/appcontype_8c.html#a67233ebfb6ba7952669a197a4cf21126" title="Close all connection producing the same input and have the same type (i.e., listen only or input only...">CloseAllConnectionsForInputWithSameType</a>(
<a name="l00568"></a>00568             connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a7ea92b8fc46bb305035ed3547516e0a7">connection_path</a>.<a class="code" href="../../dd/d06/structCipConnectionPath.html#a4f909044fc44d1e1028c105f045aca1d">connection_point</a>[1],
<a name="l00569"></a>00569             <a class="code" href="../../d2/da3/cipconnectionmanager_8h.html#aa1f0e2efd52935fd01bfece0fbead81fa1d880893638e59b11e4a2874c20ff5c3">kConnectionTypeIoInputOnly</a>);
<a name="l00570"></a>00570         <a class="code" href="../../d1/dbc/appcontype_8c.html#a67233ebfb6ba7952669a197a4cf21126" title="Close all connection producing the same input and have the same type (i.e., listen only or input only...">CloseAllConnectionsForInputWithSameType</a>(
<a name="l00571"></a>00571             connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a7ea92b8fc46bb305035ed3547516e0a7">connection_path</a>.<a class="code" href="../../dd/d06/structCipConnectionPath.html#a4f909044fc44d1e1028c105f045aca1d">connection_point</a>[1],
<a name="l00572"></a>00572             <a class="code" href="../../d2/da3/cipconnectionmanager_8h.html#aa1f0e2efd52935fd01bfece0fbead81fae26e447506c01160477cb3de20a1e438">kConnectionTypeIoListenOnly</a>);
<a name="l00573"></a>00573         <span class="keywordflow">break</span>;
<a name="l00574"></a>00574       <span class="keywordflow">case</span> <a class="code" href="../../d2/da3/cipconnectionmanager_8h.html#aa1f0e2efd52935fd01bfece0fbead81fa1d880893638e59b11e4a2874c20ff5c3">kConnectionTypeIoInputOnly</a>:
<a name="l00575"></a>00575         <span class="keywordflow">if</span> (kEipInvalidSocket
<a name="l00576"></a>00576             != connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#af79cffac5d391cb48b836dca8b893fe4">socket</a>[<a class="code" href="../../d7/d69/typedefs_8h.html#a354b9a030f385814dac5d61a8eec2e42aeb4cf2b383958e411d35e88ae386c5ec">kUdpCommuncationDirectionProducing</a>]) { <span class="comment">/* we are the controlling input only connection find a new controller*/</span>
<a name="l00577"></a>00577           next_non_control_master_connection =
<a name="l00578"></a>00578               <a class="code" href="../../d1/dbc/appcontype_8c.html#a1cbf4348c1bb5f1949d7ed38c58b2f27" title="check if there exists an producing multicast exclusive owner or listen only connection that should pr...">GetNextNonControlMasterConnection</a>(
<a name="l00579"></a>00579                   connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a7ea92b8fc46bb305035ed3547516e0a7">connection_path</a>.<a class="code" href="../../dd/d06/structCipConnectionPath.html#a4f909044fc44d1e1028c105f045aca1d">connection_point</a>[1]);
<a name="l00580"></a>00580           <span class="keywordflow">if</span> (NULL != next_non_control_master_connection) {
<a name="l00581"></a>00581             next_non_control_master_connection-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#af79cffac5d391cb48b836dca8b893fe4">socket</a>[<a class="code" href="../../d7/d69/typedefs_8h.html#a354b9a030f385814dac5d61a8eec2e42aeb4cf2b383958e411d35e88ae386c5ec">kUdpCommuncationDirectionProducing</a>] =
<a name="l00582"></a>00582                 connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#af79cffac5d391cb48b836dca8b893fe4">socket</a>[<a class="code" href="../../d7/d69/typedefs_8h.html#a354b9a030f385814dac5d61a8eec2e42aeb4cf2b383958e411d35e88ae386c5ec">kUdpCommuncationDirectionProducing</a>];
<a name="l00583"></a>00583             connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#af79cffac5d391cb48b836dca8b893fe4">socket</a>[<a class="code" href="../../d7/d69/typedefs_8h.html#a354b9a030f385814dac5d61a8eec2e42aeb4cf2b383958e411d35e88ae386c5ec">kUdpCommuncationDirectionProducing</a>] =
<a name="l00584"></a>00584                 kEipInvalidSocket;
<a name="l00585"></a>00585             next_non_control_master_connection-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a8ff49ae39efff1f6e82d66bca01f995b">transmission_trigger_timer</a> =
<a name="l00586"></a>00586                 connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a8ff49ae39efff1f6e82d66bca01f995b">transmission_trigger_timer</a>;
<a name="l00587"></a>00587           } <span class="keywordflow">else</span> { <span class="comment">/* this was the last master connection close all listen only connections listening on the port */</span>
<a name="l00588"></a>00588             <a class="code" href="../../d1/dbc/appcontype_8c.html#a67233ebfb6ba7952669a197a4cf21126" title="Close all connection producing the same input and have the same type (i.e., listen only or input only...">CloseAllConnectionsForInputWithSameType</a>(
<a name="l00589"></a>00589                 connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a7ea92b8fc46bb305035ed3547516e0a7">connection_path</a>.<a class="code" href="../../dd/d06/structCipConnectionPath.html#a4f909044fc44d1e1028c105f045aca1d">connection_point</a>[1],
<a name="l00590"></a>00590                 <a class="code" href="../../d2/da3/cipconnectionmanager_8h.html#aa1f0e2efd52935fd01bfece0fbead81fae26e447506c01160477cb3de20a1e438">kConnectionTypeIoListenOnly</a>);
<a name="l00591"></a>00591           }
<a name="l00592"></a>00592         }
<a name="l00593"></a>00593         <span class="keywordflow">break</span>;
<a name="l00594"></a>00594       <span class="keywordflow">default</span>:
<a name="l00595"></a>00595         <span class="keywordflow">break</span>;
<a name="l00596"></a>00596     }
<a name="l00597"></a>00597   }
<a name="l00598"></a>00598 
<a name="l00599"></a>00599   <a class="code" href="../../dd/d1b/POSIX_2sample__application_2opener__user__conf_8h.html#a7b5e7d71f666ba97788b35be1617c40a">OPENER_ASSERT</a>(NULL != connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a51af396f09a2874cecd1d463c85e2a34">connection_close_function</a>);
<a name="l00600"></a>00600   connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a51af396f09a2874cecd1d463c85e2a34">connection_close_function</a>(connection_object);
<a name="l00601"></a>00601 }
<a name="l00602"></a>00602 
<a name="l00603"></a><a class="code" href="../../df/d03/cipioconnection_8c.html#a41f8d71772b5defa587ac0da6124cc47">00603</a> <a class="code" href="../../d7/d69/typedefs_8h.html#a3dcc5f7837c120360f8cc88a76781709" title="EIP stack status enum.">EipStatus</a> <a class="code" href="../../df/d03/cipioconnection_8c.html#a41f8d71772b5defa587ac0da6124cc47" title="Send the data from the produced CIP Object of the connection via the socket of the connection object ...">SendConnectedData</a>(<a class="code" href="../../d1/d48/structconnection__object.html">ConnectionObject</a> *<a class="code" href="../../d1/d48/structconnection__object.html">connection_object</a>) {
<a name="l00604"></a>00604 
<a name="l00605"></a>00605   <span class="comment">/* TODO think of adding an own send buffer to each connection object in order to preset up the whole message on connection opening and just change the variable data items e.g., sequence number */</span>
<a name="l00606"></a>00606 
<a name="l00607"></a>00607   <a class="code" href="../../db/d80/structCipCommonPacketFormatData.html">CipCommonPacketFormatData</a> *common_packet_format_data = &amp;<a class="code" href="../../d4/d91/group__ENCAP.html#gafaae5be8de81c633ea4df46fa8b957e0" title="Data storage for the any CPF data Currently we are single threaded and need only one CPF at the time...">g_common_packet_format_data_item</a>; <span class="comment">/* TODO think on adding a CPF data item to the S_CIP_ConnectionObject in order to remove the code here or even better allocate memory in the connection object for storing the message to send and just change the application data*/</span>
<a name="l00608"></a>00608 
<a name="l00609"></a>00609   connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#aa31634b17dcfdd7d98ad8b4219558dbf">eip_level_sequence_count_producing</a>++;
<a name="l00610"></a>00610 
<a name="l00611"></a>00611   <span class="comment">/* assembleCPFData */</span>
<a name="l00612"></a>00612   common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#a7ff1108c27f9ebe1d69305311c6b234b">item_count</a> = 2;
<a name="l00613"></a>00613   <span class="keywordflow">if</span> ((connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#aee393bffe6bd92fb313db48832665254">transport_type_class_trigger</a> &amp; 0x0F) != 0) { <span class="comment">/* use Sequenced Address Items if not Connection Class 0 */</span>
<a name="l00614"></a>00614     common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#a6f7f7299bfdc600609c9b9f8fc55ac5b">address_item</a>.<a class="code" href="../../d3/d56/structAddressItem.html#a9b3cf54385b7e3db0c41d4d394c2d465">type_id</a> = <a class="code" href="../../d4/d91/group__ENCAP.html#ggafdcff621008b5e305165424c6ac4ea25a21abefabf9f64dba055671507015f2b1">kCipItemIdSequencedAddressItem</a>;
<a name="l00615"></a>00615     common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#a6f7f7299bfdc600609c9b9f8fc55ac5b">address_item</a>.<a class="code" href="../../d3/d56/structAddressItem.html#a8651f8610143cd0ef830abdc1fcf00b2">length</a> = 8;
<a name="l00616"></a>00616     common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#a6f7f7299bfdc600609c9b9f8fc55ac5b">address_item</a>.<a class="code" href="../../d3/d56/structAddressItem.html#ae405cdded64b36b5bbad607ea251865a">data</a>.<a class="code" href="../../d9/da2/structAddressData.html#a41d4480ab2d89c04cd9211586be88ba5">sequence_number</a> =
<a name="l00617"></a>00617         connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#aa31634b17dcfdd7d98ad8b4219558dbf">eip_level_sequence_count_producing</a>;
<a name="l00618"></a>00618   } <span class="keywordflow">else</span> {
<a name="l00619"></a>00619     common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#a6f7f7299bfdc600609c9b9f8fc55ac5b">address_item</a>.<a class="code" href="../../d3/d56/structAddressItem.html#a9b3cf54385b7e3db0c41d4d394c2d465">type_id</a> = <a class="code" href="../../d4/d91/group__ENCAP.html#ggafdcff621008b5e305165424c6ac4ea25a0adf8007a319941f3aaa7d9624025c0f">kCipItemIdConnectionAddress</a>;
<a name="l00620"></a>00620     common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#a6f7f7299bfdc600609c9b9f8fc55ac5b">address_item</a>.<a class="code" href="../../d3/d56/structAddressItem.html#a8651f8610143cd0ef830abdc1fcf00b2">length</a> = 4;
<a name="l00621"></a>00621 
<a name="l00622"></a>00622   }
<a name="l00623"></a>00623   common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#a6f7f7299bfdc600609c9b9f8fc55ac5b">address_item</a>.<a class="code" href="../../d3/d56/structAddressItem.html#ae405cdded64b36b5bbad607ea251865a">data</a>.<a class="code" href="../../d9/da2/structAddressData.html#a955e0fc2a462a58b78f0da83df66a307">connection_identifier</a> =
<a name="l00624"></a>00624       connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a1094de5e83a2b9f85b2a622c1a01bfbe">produced_connection_id</a>;
<a name="l00625"></a>00625 
<a name="l00626"></a>00626   common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#a054b7138d1a6837b9ade41b17635bc96">data_item</a>.<a class="code" href="../../de/d71/structDataItem.html#acf4b53bdfe8766830d313e9c7e1cf5dc">type_id</a> = <a class="code" href="../../d4/d91/group__ENCAP.html#ggafdcff621008b5e305165424c6ac4ea25a8761662aa0838fb723f8696e9ea4e217">kCipItemIdConnectedDataItem</a>;
<a name="l00627"></a>00627 
<a name="l00628"></a>00628   <a class="code" href="../../de/dd7/structCipByteArray.html" title="CIP Byte Array.">CipByteArray</a> *producing_instance_attributes =
<a name="l00629"></a>00629       (<a class="code" href="../../de/dd7/structCipByteArray.html" title="CIP Byte Array.">CipByteArray</a> *) connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#ab486fb828cb85f57c53abea69ad9faff">producing_instance</a>-&gt;<a class="code" href="../../d5/dc5/structcip__instance.html#ada5c4109b95cb6635f4aa32a2e6d74bf">attributes</a>-&gt;<a class="code" href="../../d4/d62/structCipAttributeStruct.html#a859d8bdd91ff42b1ce0ff5f8053d2b40">data</a>;
<a name="l00630"></a>00630   common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#a054b7138d1a6837b9ade41b17635bc96">data_item</a>.<a class="code" href="../../de/d71/structDataItem.html#a70de504e7692ab2c73be4c96911c9b05">length</a> = 0;
<a name="l00631"></a>00631 
<a name="l00632"></a>00632   <span class="comment">/* notify the application that data will be sent immediately after the call */</span>
<a name="l00633"></a>00633   if (<a class="code" href="../../d5/dc5/group__CIP__CALLBACK__API.html#ga098272a8ae10facf3086c5c82a0080db" title="Inform the application that the data of an assembly object will be sent.">BeforeAssemblyDataSend</a>(connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#ab486fb828cb85f57c53abea69ad9faff">producing_instance</a>)) {
<a name="l00634"></a>00634     <span class="comment">/* the data has changed increase sequence counter */</span>
<a name="l00635"></a>00635     connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a3bdc60cec812eb1fa09d731971c28c59">sequence_count_producing</a>++;
<a name="l00636"></a>00636   }
<a name="l00637"></a>00637 
<a name="l00638"></a>00638   <span class="comment">/* set AddressInfo Items to invalid Type */</span>
<a name="l00639"></a>00639   common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#afc2883222efe7445cb7836d5da872f54">address_info_item</a>[0].<a class="code" href="../../dc/d3c/structSocketAddressInfoItem.html#ad71289b55ab0ff6a4382af44afaccca2">type_id</a> = 0;
<a name="l00640"></a>00640   common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#afc2883222efe7445cb7836d5da872f54">address_info_item</a>[1].<a class="code" href="../../dc/d3c/structSocketAddressInfoItem.html#ad71289b55ab0ff6a4382af44afaccca2">type_id</a> = 0;
<a name="l00641"></a>00641 
<a name="l00642"></a>00642   <a class="code" href="../../d7/d69/typedefs_8h.html#ac1b4cfa25b4f5def62f23b455dd395d8">EipUint16</a> reply_length = <a class="code" href="../../d4/d91/group__ENCAP.html#gad61fa4f84989cf27086d57557ad552c4">AssembleIOMessage</a>(common_packet_format_data,
<a name="l00643"></a>00643                                    &amp;<a class="code" href="../../d2/d3d/cipcommon_8c.html#a5bd888b31f309543df6dc57652d2ac48">g_message_data_reply_buffer</a>[0]);
<a name="l00644"></a>00644 
<a name="l00645"></a>00645   <a class="code" href="../../d7/d69/typedefs_8h.html#aa0c108ee762a27720919a4634643040e">EipUint8</a> *message_data_reply_buffer = &amp;<a class="code" href="../../d2/d3d/cipcommon_8c.html#a5bd888b31f309543df6dc57652d2ac48">g_message_data_reply_buffer</a>[reply_length - 2];
<a name="l00646"></a>00646   common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#a054b7138d1a6837b9ade41b17635bc96">data_item</a>.<a class="code" href="../../de/d71/structDataItem.html#a70de504e7692ab2c73be4c96911c9b05">length</a> = producing_instance_attributes
<a name="l00647"></a>00647       -&gt;<a class="code" href="../../de/dd7/structCipByteArray.html#a2fc468bacd1d1300da4286bb838b7f7b">length</a>;
<a name="l00648"></a>00648   <span class="keywordflow">if</span> (kOpenerProducedDataHasRunIdleHeader) {
<a name="l00649"></a>00649     common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#a054b7138d1a6837b9ade41b17635bc96">data_item</a>.<a class="code" href="../../de/d71/structDataItem.html#a70de504e7692ab2c73be4c96911c9b05">length</a> += 4;
<a name="l00650"></a>00650   }
<a name="l00651"></a>00651 
<a name="l00652"></a>00652   <span class="keywordflow">if</span> ((connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#aee393bffe6bd92fb313db48832665254">transport_type_class_trigger</a> &amp; 0x0F) == 1) {
<a name="l00653"></a>00653     common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#a054b7138d1a6837b9ade41b17635bc96">data_item</a>.<a class="code" href="../../de/d71/structDataItem.html#a70de504e7692ab2c73be4c96911c9b05">length</a> += 2;
<a name="l00654"></a>00654     <a class="code" href="../../d4/d91/group__ENCAP.html#gae689aac2a85bf49fb356ec94c8800799" title="converts UINT16 data from host to little endian an writes it to buffer.">AddIntToMessage</a>(common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#a054b7138d1a6837b9ade41b17635bc96">data_item</a>.<a class="code" href="../../de/d71/structDataItem.html#a70de504e7692ab2c73be4c96911c9b05">length</a>,
<a name="l00655"></a>00655                     &amp;message_data_reply_buffer);
<a name="l00656"></a>00656     <a class="code" href="../../d4/d91/group__ENCAP.html#gae689aac2a85bf49fb356ec94c8800799" title="converts UINT16 data from host to little endian an writes it to buffer.">AddIntToMessage</a>(connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a3bdc60cec812eb1fa09d731971c28c59">sequence_count_producing</a>,
<a name="l00657"></a>00657                     &amp;message_data_reply_buffer);
<a name="l00658"></a>00658   } <span class="keywordflow">else</span> {
<a name="l00659"></a>00659     <a class="code" href="../../d4/d91/group__ENCAP.html#gae689aac2a85bf49fb356ec94c8800799" title="converts UINT16 data from host to little endian an writes it to buffer.">AddIntToMessage</a>(common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#a054b7138d1a6837b9ade41b17635bc96">data_item</a>.<a class="code" href="../../de/d71/structDataItem.html#a70de504e7692ab2c73be4c96911c9b05">length</a>,
<a name="l00660"></a>00660                     &amp;message_data_reply_buffer);
<a name="l00661"></a>00661   }
<a name="l00662"></a>00662 
<a name="l00663"></a>00663   <span class="keywordflow">if</span> (kOpenerProducedDataHasRunIdleHeader) {
<a name="l00664"></a>00664     <a class="code" href="../../d4/d91/group__ENCAP.html#gaafc3c9e3ff582c9b7e438ae2b1fdf822" title="Converts UINT32 data from host to little endian and writes it to buffer.">AddDintToMessage</a>(<a class="code" href="../../df/d03/cipioconnection_8c.html#a4901ec04ad1ac886626e556c60f12196">g_run_idle_state</a>, &amp;(message_data_reply_buffer));
<a name="l00665"></a>00665   }
<a name="l00666"></a>00666 
<a name="l00667"></a>00667   memcpy(message_data_reply_buffer, producing_instance_attributes-&gt;<a class="code" href="../../de/dd7/structCipByteArray.html#ad1f95b3da0adfd2aeafd5db1d415a6b9">data</a>,
<a name="l00668"></a>00668          producing_instance_attributes-&gt;<a class="code" href="../../de/dd7/structCipByteArray.html#a2fc468bacd1d1300da4286bb838b7f7b">length</a>);
<a name="l00669"></a>00669 
<a name="l00670"></a>00670   reply_length += common_packet_format_data-&gt;<a class="code" href="../../db/d80/structCipCommonPacketFormatData.html#a054b7138d1a6837b9ade41b17635bc96">data_item</a>.<a class="code" href="../../de/d71/structDataItem.html#a70de504e7692ab2c73be4c96911c9b05">length</a>;
<a name="l00671"></a>00671 
<a name="l00672"></a>00672   <span class="keywordflow">return</span> <a class="code" href="../../d5/dc5/group__CIP__CALLBACK__API.html#gad1d5f56b277bf8b4ffc431e5b0523518" title="create a producing or consuming UDP socket">SendUdpData</a>(
<a name="l00673"></a>00673       &amp;connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a32b8fe01a538f765d0cce564f705c2ea">remote_address</a>,
<a name="l00674"></a>00674       connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#af79cffac5d391cb48b836dca8b893fe4">socket</a>[<a class="code" href="../../d7/d69/typedefs_8h.html#a354b9a030f385814dac5d61a8eec2e42aeb4cf2b383958e411d35e88ae386c5ec">kUdpCommuncationDirectionProducing</a>],
<a name="l00675"></a>00675       &amp;<a class="code" href="../../d2/d3d/cipcommon_8c.html#a5bd888b31f309543df6dc57652d2ac48">g_message_data_reply_buffer</a>[0], reply_length);
<a name="l00676"></a>00676 }
<a name="l00677"></a>00677 
<a name="l00678"></a><a class="code" href="../../df/d03/cipioconnection_8c.html#aca3c7cb7fc5d8d3f86698cb4c31f108f">00678</a> <a class="code" href="../../d7/d69/typedefs_8h.html#a3dcc5f7837c120360f8cc88a76781709" title="EIP stack status enum.">EipStatus</a> <a class="code" href="../../df/d03/cipioconnection_8c.html#aca3c7cb7fc5d8d3f86698cb4c31f108f">HandleReceivedIoConnectionData</a>(<a class="code" href="../../d1/d48/structconnection__object.html">ConnectionObject</a> *<a class="code" href="../../d1/d48/structconnection__object.html">connection_object</a>,
<a name="l00679"></a>00679                                          <span class="keyword">const</span> <a class="code" href="../../d7/d69/typedefs_8h.html#aa0c108ee762a27720919a4634643040e">EipUint8</a> *data, <a class="code" href="../../d7/d69/typedefs_8h.html#ac1b4cfa25b4f5def62f23b455dd395d8">EipUint16</a> data_length) {
<a name="l00680"></a>00680 
<a name="l00681"></a>00681   <span class="comment">/* check class 1 sequence number*/</span>
<a name="l00682"></a>00682   <span class="keywordflow">if</span> ((connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#aee393bffe6bd92fb313db48832665254">transport_type_class_trigger</a> &amp; 0x0F) == 1) {
<a name="l00683"></a>00683     <a class="code" href="../../d7/d69/typedefs_8h.html#ac1b4cfa25b4f5def62f23b455dd395d8">EipUint16</a> sequence_buffer = <a class="code" href="../../d4/d91/group__ENCAP.html#ga70322f970709ca9c9a1a1d474cfe2302" title="Reads EIP_UINT16 from *buffer and converts little endian to host.">GetIntFromMessage</a>(&amp;(data));
<a name="l00684"></a>00684     <span class="keywordflow">if</span> (<a class="code" href="../../d2/da3/cipconnectionmanager_8h.html#aa90301ce80009301ef74637f50a79e69" title="similar macros for comparing 16 bit sequence numbers  SEQ_LEQ16(a, b) Checks if sequence number a is ...">SEQ_LEQ16</a>(sequence_buffer,
<a name="l00685"></a>00685                   connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#ad6c06f4b33c7bea685145806c86d2c3f">sequence_count_consuming</a>)) {
<a name="l00686"></a>00686       <span class="keywordflow">return</span> <a class="code" href="../../d7/d69/typedefs_8h.html#a3dcc5f7837c120360f8cc88a76781709af172c48a50748097201d49b469c75f7a">kEipStatusOk</a>; <span class="comment">/* no new data for the assembly */</span>
<a name="l00687"></a>00687     }
<a name="l00688"></a>00688     connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#ad6c06f4b33c7bea685145806c86d2c3f">sequence_count_consuming</a> = sequence_buffer;
<a name="l00689"></a>00689     data_length -= 2;
<a name="l00690"></a>00690   }
<a name="l00691"></a>00691 
<a name="l00692"></a>00692   <span class="keywordflow">if</span> (data_length &gt; 0) {
<a name="l00693"></a>00693     <span class="comment">/* we have no heartbeat connection */</span>
<a name="l00694"></a>00694     <span class="keywordflow">if</span> (kOpenerConsumedDataHasRunIdleHeader) {
<a name="l00695"></a>00695       <a class="code" href="../../d7/d69/typedefs_8h.html#abf2dd49262551294eb990ef8746a2767">EipUint32</a> nRunIdleBuf = <a class="code" href="../../d4/d91/group__ENCAP.html#ga668f92389ee06510864585b97955f6f8" title="Reads EIP_UINT32 from *buffer and converts little endian to host.">GetDintFromMessage</a>(&amp;(data));
<a name="l00696"></a>00696       <span class="keywordflow">if</span> (<a class="code" href="../../df/d03/cipioconnection_8c.html#a4901ec04ad1ac886626e556c60f12196">g_run_idle_state</a> != nRunIdleBuf) {
<a name="l00697"></a>00697         <a class="code" href="../../d5/dc5/group__CIP__CALLBACK__API.html#ga63bf35df0c11815a8a59d8a68ac4b569" title="Inform the application that the Run/Idle State has been changed by the originator.">RunIdleChanged</a>(nRunIdleBuf);
<a name="l00698"></a>00698       }
<a name="l00699"></a>00699       <a class="code" href="../../df/d03/cipioconnection_8c.html#a4901ec04ad1ac886626e556c60f12196">g_run_idle_state</a> = nRunIdleBuf;
<a name="l00700"></a>00700       data_length -= 4;
<a name="l00701"></a>00701     }
<a name="l00702"></a>00702 
<a name="l00703"></a>00703     <span class="keywordflow">if</span> (<a class="code" href="../../df/d2e/cipassembly_8c.html#a5dc25129faf75858c0aeaa88ea8d9490" title="notify an Assembly object that data has been received for it.">NotifyAssemblyConnectedDataReceived</a>(
<a name="l00704"></a>00704         connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#aef7f726017a6d89235c9ee8c0ef98d71">consuming_instance</a>, (<a class="code" href="../../d7/d69/typedefs_8h.html#aa0c108ee762a27720919a4634643040e">EipUint8</a> *<span class="keyword">const</span>)data, data_length) != 0) {
<a name="l00705"></a>00705       <span class="keywordflow">return</span> <a class="code" href="../../d7/d69/typedefs_8h.html#a3dcc5f7837c120360f8cc88a76781709a1ac5aa8c4de11fc51d52843b5d173184">kEipStatusError</a>;
<a name="l00706"></a>00706     }
<a name="l00707"></a>00707   }
<a name="l00708"></a>00708   <span class="keywordflow">return</span> <a class="code" href="../../d7/d69/typedefs_8h.html#a3dcc5f7837c120360f8cc88a76781709af172c48a50748097201d49b469c75f7a">kEipStatusOk</a>;
<a name="l00709"></a>00709 }
<a name="l00710"></a>00710 
<a name="l00711"></a><a class="code" href="../../de/d45/cipioconnection_8h.html#adbb39670c736df4ef89589a3b4e4df4e">00711</a> <a class="code" href="../../d7/d69/typedefs_8h.html#a3dcc5f7837c120360f8cc88a76781709" title="EIP stack status enum.">EipStatus</a> <a class="code" href="../../df/d03/cipioconnection_8c.html#adbb39670c736df4ef89589a3b4e4df4e" title="Take the data given in the connection object structure and open the necessary communication channels...">OpenCommunicationChannels</a>(<a class="code" href="../../d1/d48/structconnection__object.html">ConnectionObject</a> *<a class="code" href="../../d1/d48/structconnection__object.html">connection_object</a>) {
<a name="l00712"></a>00712 
<a name="l00713"></a>00713   <a class="code" href="../../d7/d69/typedefs_8h.html#a3dcc5f7837c120360f8cc88a76781709" title="EIP stack status enum.">EipStatus</a> eip_status = <a class="code" href="../../d7/d69/typedefs_8h.html#a3dcc5f7837c120360f8cc88a76781709af172c48a50748097201d49b469c75f7a">kEipStatusOk</a>;
<a name="l00714"></a>00714   <span class="comment">/*get pointer to the CPF data, currently we have just one global instance of the struct. This may change in the future*/</span>
<a name="l00715"></a>00715   <a class="code" href="../../db/d80/structCipCommonPacketFormatData.html">CipCommonPacketFormatData</a> *common_packet_format_data =
<a name="l00716"></a>00716       &amp;<a class="code" href="../../d4/d91/group__ENCAP.html#gafaae5be8de81c633ea4df46fa8b957e0" title="Data storage for the any CPF data Currently we are single threaded and need only one CPF at the time...">g_common_packet_format_data_item</a>;
<a name="l00717"></a>00717 
<a name="l00718"></a>00718   <a class="code" href="../../df/d03/cipioconnection_8c.html#ac135b4e48a22ceabff84d2147f00e73d" title="Gives the cardinality of a connection endpoint, either point to point or point to multipoint...">CommunicationEndpointCardinality</a> originator_to_target_connection_type = (connection_object
<a name="l00719"></a>00719       -&gt;<a class="code" href="../../d1/d48/structconnection__object.html#af1d980ce6b30a318e559cf32d23aa0ec">o_to_t_network_connection_parameter</a> &amp; 0x6000) &gt;&gt; 13;
<a name="l00720"></a>00720 
<a name="l00721"></a>00721   <a class="code" href="../../df/d03/cipioconnection_8c.html#ac135b4e48a22ceabff84d2147f00e73d" title="Gives the cardinality of a connection endpoint, either point to point or point to multipoint...">CommunicationEndpointCardinality</a> target_to_originator_connection_type = (connection_object
<a name="l00722"></a>00722       -&gt;<a class="code" href="../../d1/d48/structconnection__object.html#a8ccf723e8dce62eb578a046fd35a774f">t_to_o_network_connection_parameter</a> &amp; 0x6000) &gt;&gt; 13;
<a name="l00723"></a>00723 
<a name="l00724"></a>00724   <span class="comment">/* open a connection &quot;point to point&quot; or &quot;multicast&quot; based on the ConnectionParameter */</span>
<a name="l00725"></a>00725   <span class="keywordflow">if</span> (originator_to_target_connection_type == <a class="code" href="../../df/d03/cipioconnection_8c.html#ac135b4e48a22ceabff84d2147f00e73daed5eda863b8019d3edca8fdac1df8bba">PointToMultipoint</a>) <span class="comment">/* Multicast consuming */</span>
<a name="l00726"></a>00726   {
<a name="l00727"></a>00727     <span class="keywordflow">if</span> (<a class="code" href="../../df/d03/cipioconnection_8c.html#a9937b2aeb5fd393c7861e25f04c9f1c1">OpenMulticastConnection</a>(<a class="code" href="../../d7/d69/typedefs_8h.html#a354b9a030f385814dac5d61a8eec2e42a922e4c2f521c295287766f9917c9fea7">kUdpCommuncationDirectionConsuming</a>,
<a name="l00728"></a>00728                                 connection_object, common_packet_format_data)
<a name="l00729"></a>00729         == <a class="code" href="../../d7/d69/typedefs_8h.html#a3dcc5f7837c120360f8cc88a76781709a1ac5aa8c4de11fc51d52843b5d173184">kEipStatusError</a>) {
<a name="l00730"></a>00730       <a class="code" href="../../d1/d1b/trace_8h.html#a48f0d8056c030015f14cf5907315e6bb">OPENER_TRACE_ERR</a>(<span class="stringliteral">&quot;error in OpenMulticast Connection\n&quot;</span>);
<a name="l00731"></a>00731       <span class="keywordflow">return</span> <a class="code" href="../../d6/d52/ciperror_8h.html#a01a2d66a1bdaea7c81e29d4d2530d218a8db04c3335e9735af7d59cf4b7cbdc4b">kCipErrorConnectionFailure</a>;
<a name="l00732"></a>00732     }
<a name="l00733"></a>00733   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (originator_to_target_connection_type == <a class="code" href="../../df/d03/cipioconnection_8c.html#ac135b4e48a22ceabff84d2147f00e73dae393317b471be5998af43963b2683ec9">PointToPoint</a>) <span class="comment">/* Point to Point consuming */</span>
<a name="l00734"></a>00734   {
<a name="l00735"></a>00735     <span class="keywordflow">if</span> (<a class="code" href="../../df/d03/cipioconnection_8c.html#a6a6634d74fcc5bd0eb35ec8d8c740fb6" title="Open a Point2Point connection dependent on pa_direction.">OpenConsumingPointToPointConnection</a>(connection_object,
<a name="l00736"></a>00736                                             common_packet_format_data)
<a name="l00737"></a>00737         == <a class="code" href="../../d7/d69/typedefs_8h.html#a3dcc5f7837c120360f8cc88a76781709a1ac5aa8c4de11fc51d52843b5d173184">kEipStatusError</a>) {
<a name="l00738"></a>00738       <a class="code" href="../../d1/d1b/trace_8h.html#a48f0d8056c030015f14cf5907315e6bb">OPENER_TRACE_ERR</a>(<span class="stringliteral">&quot;error in PointToPoint consuming connection\n&quot;</span>);
<a name="l00739"></a>00739       <span class="keywordflow">return</span> <a class="code" href="../../d6/d52/ciperror_8h.html#a01a2d66a1bdaea7c81e29d4d2530d218a8db04c3335e9735af7d59cf4b7cbdc4b">kCipErrorConnectionFailure</a>;
<a name="l00740"></a>00740     }
<a name="l00741"></a>00741   }
<a name="l00742"></a>00742 
<a name="l00743"></a>00743   <span class="keywordflow">if</span> (target_to_originator_connection_type == <a class="code" href="../../df/d03/cipioconnection_8c.html#ac135b4e48a22ceabff84d2147f00e73daed5eda863b8019d3edca8fdac1df8bba">PointToMultipoint</a>) <span class="comment">/* Multicast producing */</span>
<a name="l00744"></a>00744   {
<a name="l00745"></a>00745     <span class="keywordflow">if</span> (<a class="code" href="../../df/d03/cipioconnection_8c.html#a281f0a261db50e297593dd3383093fb0">OpenProducingMulticastConnection</a>(connection_object,
<a name="l00746"></a>00746                                          common_packet_format_data)
<a name="l00747"></a>00747         == <a class="code" href="../../d7/d69/typedefs_8h.html#a3dcc5f7837c120360f8cc88a76781709a1ac5aa8c4de11fc51d52843b5d173184">kEipStatusError</a>) {
<a name="l00748"></a>00748       <a class="code" href="../../d1/d1b/trace_8h.html#a48f0d8056c030015f14cf5907315e6bb">OPENER_TRACE_ERR</a>(<span class="stringliteral">&quot;error in OpenMulticast Connection\n&quot;</span>);
<a name="l00749"></a>00749       <span class="keywordflow">return</span> <a class="code" href="../../d6/d52/ciperror_8h.html#a01a2d66a1bdaea7c81e29d4d2530d218a8db04c3335e9735af7d59cf4b7cbdc4b">kCipErrorConnectionFailure</a>;
<a name="l00750"></a>00750     }
<a name="l00751"></a>00751   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (target_to_originator_connection_type == <a class="code" href="../../df/d03/cipioconnection_8c.html#ac135b4e48a22ceabff84d2147f00e73dae393317b471be5998af43963b2683ec9">PointToPoint</a>) <span class="comment">/* Point to Point producing */</span>
<a name="l00752"></a>00752   {
<a name="l00753"></a>00753 
<a name="l00754"></a>00754     <span class="keywordflow">if</span> (<a class="code" href="../../df/d03/cipioconnection_8c.html#ab5ba6f9cb3103c1db76c2bf7ae3cce8d">OpenProducingPointToPointConnection</a>(connection_object,
<a name="l00755"></a>00755                                             common_packet_format_data)
<a name="l00756"></a>00756         != <a class="code" href="../../d7/d69/typedefs_8h.html#a3dcc5f7837c120360f8cc88a76781709af172c48a50748097201d49b469c75f7a">kEipStatusOk</a>) {
<a name="l00757"></a>00757       <a class="code" href="../../d1/d1b/trace_8h.html#a48f0d8056c030015f14cf5907315e6bb">OPENER_TRACE_ERR</a>(<span class="stringliteral">&quot;error in PointToPoint producing connection\n&quot;</span>);
<a name="l00758"></a>00758       <span class="keywordflow">return</span> <a class="code" href="../../d6/d52/ciperror_8h.html#a01a2d66a1bdaea7c81e29d4d2530d218a8db04c3335e9735af7d59cf4b7cbdc4b">kCipErrorConnectionFailure</a>;
<a name="l00759"></a>00759     }
<a name="l00760"></a>00760   }
<a name="l00761"></a>00761   <span class="keywordflow">return</span> eip_status;
<a name="l00762"></a>00762 }
<a name="l00763"></a>00763 
<a name="l00764"></a><a class="code" href="../../de/d45/cipioconnection_8h.html#ab63a9cebd7f44ee474ac1fd446d5bc66">00764</a> <span class="keywordtype">void</span> <a class="code" href="../../df/d03/cipioconnection_8c.html#ab63a9cebd7f44ee474ac1fd446d5bc66" title="close the communication channels of the given connection and remove it from the active connections li...">CloseCommunicationChannelsAndRemoveFromActiveConnectionsList</a>(
<a name="l00765"></a>00765     <a class="code" href="../../d1/d48/structconnection__object.html">ConnectionObject</a> *<a class="code" href="../../d1/d48/structconnection__object.html">connection_object</a>) {
<a name="l00766"></a>00766   <a class="code" href="../../db/d4f/generic__networkhandler_8c.html#a37e718bdfa6e3b780b5135330b9cb5e5">IApp_CloseSocket_udp</a>(
<a name="l00767"></a>00767       connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#af79cffac5d391cb48b836dca8b893fe4">socket</a>[<a class="code" href="../../d7/d69/typedefs_8h.html#a354b9a030f385814dac5d61a8eec2e42a922e4c2f521c295287766f9917c9fea7">kUdpCommuncationDirectionConsuming</a>]);
<a name="l00768"></a>00768   connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#af79cffac5d391cb48b836dca8b893fe4">socket</a>[<a class="code" href="../../d7/d69/typedefs_8h.html#a354b9a030f385814dac5d61a8eec2e42a922e4c2f521c295287766f9917c9fea7">kUdpCommuncationDirectionConsuming</a>] =
<a name="l00769"></a>00769       kEipInvalidSocket;
<a name="l00770"></a>00770   <a class="code" href="../../db/d4f/generic__networkhandler_8c.html#a37e718bdfa6e3b780b5135330b9cb5e5">IApp_CloseSocket_udp</a>(
<a name="l00771"></a>00771       connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#af79cffac5d391cb48b836dca8b893fe4">socket</a>[<a class="code" href="../../d7/d69/typedefs_8h.html#a354b9a030f385814dac5d61a8eec2e42aeb4cf2b383958e411d35e88ae386c5ec">kUdpCommuncationDirectionProducing</a>]);
<a name="l00772"></a>00772   connection_object-&gt;<a class="code" href="../../d1/d48/structconnection__object.html#af79cffac5d391cb48b836dca8b893fe4">socket</a>[<a class="code" href="../../d7/d69/typedefs_8h.html#a354b9a030f385814dac5d61a8eec2e42aeb4cf2b383958e411d35e88ae386c5ec">kUdpCommuncationDirectionProducing</a>] =
<a name="l00773"></a>00773       kEipInvalidSocket;
<a name="l00774"></a>00774 
<a name="l00775"></a>00775   <a class="code" href="../../d5/d35/cipconnectionmanager_8c.html#aef50a0eee3ff5df3320b49f872a7f3c4" title="Removes connection from the list of active connections.">RemoveFromActiveConnections</a>(connection_object);
<a name="l00776"></a>00776 }
</pre></div></div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="../../df/d03/cipioconnection_8c.html">cipioconnection.c</a>      </li>

    <li class="footer">Generated on Mon Dec 19 2016 20:34:48 for OpENer - Open Source EtherNet/IP(TM)  I/O Target Stack by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
